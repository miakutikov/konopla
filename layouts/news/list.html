{{ define "main" }}
<div class="container">

  {{ partial "breadcrumbs.html" . }}

  {{ $publishedNews := where (where .Site.RegularPages "Section" "news") ".Params.draft" "ne" true }}

  <section class="news-page-layout">
    <!-- Category sidebar -->
    <aside class="categories-sidebar">
      <h3 class="sidebar-heading">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</h3>
      <ul class="categories-list">
        <li>
          <a href="{{ "/news/" | relURL }}" class="category-item active">
            <span class="category-name">–£—Å—ñ –Ω–æ–≤–∏–Ω–∏</span>
            <span class="category-count">{{ len $publishedNews }}</span>
          </a>
        </li>
        {{ $categories := slice
          (dict "name" "—Ç–µ–∫—Å—Ç–∏–ª—å" "emoji" "üßµ")
          (dict "name" "–±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ" "emoji" "üèóÔ∏è")
          (dict "name" "–∞–≥—Ä–æ" "emoji" "üå±")
          (dict "name" "–±—ñ–æ–ø–ª–∞—Å—Ç–∏–∫" "emoji" "‚ôªÔ∏è")
          (dict "name" "—Ö–∞—Ä—á–æ–≤–∞" "emoji" "ü•ó")
          (dict "name" "–∞–≤—Ç–æ–ø—Ä–æ–º" "emoji" "üöó")
          (dict "name" "–µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞" "emoji" "‚ö°")
          (dict "name" "–∫–æ—Å–º–µ—Ç–∏–∫–∞" "emoji" "‚ú®")
          (dict "name" "–Ω–∞—É–∫–∞" "emoji" "üî¨")
          (dict "name" "–µ–∫–æ–ª–æ–≥—ñ—è" "emoji" "üåç")
          (dict "name" "–±—ñ–∑–Ω–µ—Å" "emoji" "üíº")
          (dict "name" "–∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ" "emoji" "üìã")
        }}
        {{ range $categories }}
        {{ $count := 0 }}
        {{ with index $.Site.Taxonomies.categories (lower .name) }}
          {{ $count = .Count }}
        {{ end }}
        {{ if gt $count 0 }}
        <li>
          <a href="{{ "/categories/" | relURL }}{{ .name | urlize }}/" class="category-item">
            <span class="category-emoji">{{ .emoji }}</span>
            <span class="category-name">{{ .name | title }}</span>
            <span class="category-count">{{ $count }}</span>
          </a>
        </li>
        {{ end }}
        {{ end }}
      </ul>
      {{ if $.Site.Taxonomies.tags }}
      <div class="sidebar-tags">
        <h3 class="sidebar-heading">–¢–µ–≥–∏</h3>
        <div class="tags">
          {{ range $.Site.Taxonomies.tags.ByCount }}
          <a href="{{ "/tags/" | relURL }}{{ .Name | urlize }}/" class="tag">#{{ .Name }}</a>
          {{ end }}
        </div>
        <button class="tags-toggle" onclick="this.previousElementSibling.classList.toggle('expanded'); this.textContent = this.previousElementSibling.classList.contains('expanded') ? '–ó–≥–æ—Ä–Ω—É—Ç–∏ ‚ñ≤' : '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ ‚ñº'">–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ ‚ñº</button>
      </div>
      {{ end }}
    </aside>

    <!-- News content -->
    <div class="news-content">
      <div class="news-content-header">
        <h1>–ù–æ–≤–∏–Ω–∏</h1>
        <p class="list-count">{{ len $publishedNews }} –Ω–æ–≤–∏–Ω</p>
      </div>

      {{ $paginator := .Paginate $publishedNews }}
      <div class="news-grid">
        {{ range $paginator.Pages }}
          {{ partial "article-card.html" . }}
        {{ end }}
      </div>

      <!-- Load more -->
      {{ if gt $paginator.TotalPages 1 }}
      <div id="load-more-container" class="load-more-container">
        <button id="load-more-btn" class="load-more-btn" data-total-pages="{{ $paginator.TotalPages }}">
          –ü–æ–∫–∞–∑–∞—Ç–∏ —â–µ
        </button>
        <div id="load-more-spinner" class="load-more-spinner" style="display:none">
          <div class="spinner"></div>
          <span>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
        </div>
      </div>
      <script>
      (function() {
        var btn = document.getElementById('load-more-btn');
        if (!btn) return;
        var currentPage = 1;
        var totalPages = parseInt(btn.dataset.totalPages, 10);
        var grid = document.querySelector('.news-content .news-grid');
        var spinner = document.getElementById('load-more-spinner');
        var container = document.getElementById('load-more-container');

        btn.addEventListener('click', async function() {
          if (currentPage >= totalPages) return;
          btn.style.display = 'none';
          spinner.style.display = 'flex';
          currentPage++;
          var nextUrl = '/news/page/' + currentPage + '/';
          try {
            var resp = await fetch(nextUrl);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            var html = await resp.text();
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var newCards = doc.querySelectorAll('.news-grid .news-card');
            newCards.forEach(function(card) {
              grid.appendChild(document.importNode(card, true));
            });
            if (currentPage >= totalPages) {
              container.style.display = 'none';
            } else {
              btn.style.display = 'inline-block';
              spinner.style.display = 'none';
            }
          } catch (e) {
            console.error('Load more error:', e);
            btn.textContent = '–ü–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É?';
            btn.style.display = 'inline-block';
            spinner.style.display = 'none';
          }
        });
      })();
      </script>
      {{ end }}
    </div>
  </section>

</div>
{{ end }}
