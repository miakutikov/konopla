{{ define "main" }}
<!-- Quill WYSIWYG editor -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/turndown@7.2.0/dist/turndown.js"></script>

<div class="container">
  <div id="admin-app">

    <!-- Auth screen -->
    <div id="auth-screen" class="admin-auth">
      <div class="auth-card">
        <h1>üîê –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <p>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É</p>
        <form id="auth-form">
          <input type="password" id="auth-key" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" class="auth-input">
          <button type="submit" class="auth-btn">–£–≤—ñ–π—Ç–∏</button>
        </form>
        <p id="auth-error" class="auth-error" style="display:none">–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å</p>
      </div>
    </div>

    <!-- Admin panel (hidden until auth) -->
    <div id="admin-panel" style="display:none">
      <div class="admin-header">
        <h1>üåø KONOPLA.UA ‚Äî –ú–æ–¥–µ—Ä–∞—Ü—ñ—è</h1>
        <div class="admin-actions-top">
          <button class="admin-btn" onclick="toggleCreateForm()">‚úçÔ∏è –ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è</button>
          <button id="btn-refresh" class="admin-btn" onclick="loadDrafts()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
          <button id="btn-run-pipeline" class="admin-btn admin-btn-green" onclick="runPipeline()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–±—ñ—Ä</button>
          <button id="btn-ua-pipeline" class="admin-btn admin-btn-ua" onclick="runUaPipeline()">üá∫üá¶ UA –Ω–æ–≤–∏–Ω–∏</button>
          <button id="btn-logout" class="admin-btn admin-btn-dim" onclick="logout()">–í–∏–π—Ç–∏</button>
        </div>
      </div>

      <div id="status-bar" class="admin-status" style="display:none"></div>

      <!-- Create article form (hidden by default) -->
      <div id="create-form" class="create-form" style="display:none">
        <div class="create-form-card">
          <div class="create-form-header">
            <h2>‚úçÔ∏è –ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è</h2>
            <button class="admin-btn admin-btn-dim" onclick="toggleCreateForm()">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
          </div>

          <div class="cf-row">
            <div class="cf-field cf-field-wide">
              <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
              <input type="text" id="cf-title" maxlength="120" placeholder="–ß—ñ—Ç–∫–∏–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫">
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field">
              <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
              <select id="cf-category">
                <option value="—Ç–µ–∫—Å—Ç–∏–ª—å">üßµ —Ç–µ–∫—Å—Ç–∏–ª—å</option>
                <option value="–±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ">üèóÔ∏è –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ</option>
                <option value="–∞–≥—Ä–æ">üå± –∞–≥—Ä–æ</option>
                <option value="–±—ñ–æ–ø–ª–∞—Å—Ç–∏–∫">‚ôªÔ∏è –±—ñ–æ–ø–ª–∞—Å—Ç–∏–∫</option>
                <option value="—Ö–∞—Ä—á–æ–≤–∞">ü•ó —Ö–∞—Ä—á–æ–≤–∞</option>
                <option value="–∞–≤—Ç–æ–ø—Ä–æ–º">üöó –∞–≤—Ç–æ–ø—Ä–æ–º</option>
                <option value="–µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞">‚ö° –µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞</option>
                <option value="–∫–æ—Å–º–µ—Ç–∏–∫–∞">‚ú® –∫–æ—Å–º–µ—Ç–∏–∫–∞</option>
                <option value="–Ω–∞—É–∫–∞">üî¨ –Ω–∞—É–∫–∞</option>
                <option value="–µ–∫–æ–ª–æ–≥—ñ—è">üåç –µ–∫–æ–ª–æ–≥—ñ—è</option>
                <option value="–±—ñ–∑–Ω–µ—Å">üíº –±—ñ–∑–Ω–µ—Å</option>
                <option value="–∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ">üìã –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ</option>
                <option value="–≤—ñ–¥–µ–æ">üé¨ –≤—ñ–¥–µ–æ</option>
                <option value="—ñ–Ω—à–µ">üì∞ —ñ–Ω—à–µ</option>
              </select>
            </div>
            <div class="cf-field">
              <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
              <input type="text" id="cf-tags" placeholder="–∫–æ–Ω–æ–ø–ª—ñ, —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó, –£–∫—Ä–∞—ó–Ω–∞">
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field cf-field-wide">
              <label>–ê–Ω–æ–Ω—Å (summary)</label>
              <textarea id="cf-summary" rows="2" maxlength="300" placeholder="1-2 —Ä–µ—á–µ–Ω–Ω—è –¥–ª—è –∫–∞—Ä—Ç–∫–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π"></textarea>
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field cf-field-wide">
              <label>–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ *</label>
              <div id="cf-editor"></div>
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field">
              <label>URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
              <input type="text" id="cf-image" placeholder="https://example.com/photo.jpg">
            </div>
            <div class="cf-field">
              <label>YouTube ID</label>
              <div class="yt-field-row">
                <input type="text" id="cf-youtube" placeholder="dQw4w9WgXcQ">
                <button type="button" class="admin-btn admin-btn-yt-search" onclick="openYtSearch()">üé¨ –ó–Ω–∞–π—Ç–∏</button>
              </div>
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field">
              <label>–î–∂–µ—Ä–µ–ª–æ</label>
              <input type="text" id="cf-source" placeholder="KONOPLA.UA" value="KONOPLA.UA">
            </div>
            <div class="cf-field">
              <label>URL –¥–∂–µ—Ä–µ–ª–∞</label>
              <input type="text" id="cf-source-url" placeholder="https://konopla.ua">
            </div>
          </div>

          <div class="cf-actions">
            <button class="admin-btn admin-btn-green cf-submit-btn" onclick="createArticle()">üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é</button>
            <button class="admin-btn admin-btn-dim" onclick="toggleCreateForm()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          </div>
        </div>
      </div>

      <div id="drafts-list" class="drafts-list">
        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      </div>

      <div id="empty-state" class="admin-empty" style="display:none">
        <h2>üì≠ –ù–µ–º–∞—î —Å—Ç–∞—Ç–µ–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó</h2>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–±—ñ—Ä¬ª –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –Ω–æ–≤–∏–Ω</p>
      </div>

      <!-- Deploy queue -->
      <div id="deploy-queue" class="deploy-queue" style="display:none">
        <div class="deploy-queue-header">
          <h2>üöÄ –ß–µ—Ä–≥–∞ –Ω–∞ –¥–µ–ø–ª–æ–π</h2>
          <div class="deploy-queue-actions">
            <button class="admin-btn admin-btn-green" onclick="deployAll()">üöÄ –ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ (<span id="queue-count">0</span>)</button>
            <div class="schedule-row">
              <input type="datetime-local" id="schedule-deploy-time" class="schedule-input">
              <button class="admin-btn admin-btn-schedule" onclick="scheduleAction('deploy')">‚è∞ –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏</button>
            </div>
            <button class="admin-btn admin-btn-dim" onclick="clearQueue()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="queue-items" class="queue-items"></div>
        <div id="scheduled-deploy" class="scheduled-items"></div>
      </div>

      <!-- Telegram queue -->
      <div id="tg-queue" class="deploy-queue tg-queue" style="display:none">
        <div class="deploy-queue-header">
          <h2>üì® –ß–µ—Ä–≥–∞ Telegram</h2>
          <div class="deploy-queue-actions">
            <button class="admin-btn admin-btn-tg" onclick="postToTelegram()">üì® –ü–æ—Å—Ç–∏—Ç–∏ –≤ Telegram (<span id="tg-queue-count">0</span>)</button>
            <div class="schedule-row">
              <input type="datetime-local" id="schedule-telegram-time" class="schedule-input">
              <button class="admin-btn admin-btn-schedule" onclick="scheduleAction('telegram')">‚è∞ –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏</button>
            </div>
            <button class="admin-btn admin-btn-dim" onclick="clearTgQueue()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="tg-queue-items" class="queue-items"></div>
        <div id="scheduled-telegram" class="scheduled-items"></div>
      </div>

      <!-- Threads queue -->
      <div id="threads-queue" class="deploy-queue threads-queue" style="display:none">
        <div class="deploy-queue-header">
          <h2>üßµ –ß–µ—Ä–≥–∞ Threads</h2>
          <div class="deploy-queue-actions">
            <button class="admin-btn admin-btn-threads" onclick="postToThreads()">üßµ –ü–æ—Å—Ç–∏—Ç–∏ –≤ Threads (<span id="threads-queue-count">0</span>)</button>
            <div class="schedule-row">
              <input type="datetime-local" id="schedule-threads-time" class="schedule-input">
              <button class="admin-btn admin-btn-schedule" onclick="scheduleAction('threads')">‚è∞ –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏</button>
            </div>
            <button class="admin-btn admin-btn-dim" onclick="clearThreadsQueue()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="threads-queue-items" class="queue-items"></div>
        <div id="scheduled-threads" class="scheduled-items"></div>
      </div>

      <!-- YouTube search modal -->
      <div id="yt-modal" class="yt-modal" style="display:none">
        <div class="yt-modal-overlay" onclick="closeYtSearch()"></div>
        <div class="yt-modal-content">
          <div class="yt-modal-header">
            <h2>üé¨ –ü–æ—à—É–∫ YouTube</h2>
            <button class="admin-btn admin-btn-dim" onclick="closeYtSearch()">‚úï</button>
          </div>
          <div class="yt-search-row">
            <input type="text" id="yt-search-input" placeholder="–ü—Ä–æ–º–∏—Å–ª–æ–≤—ñ –∫–æ–Ω–æ–ø–ª—ñ, hemp textile..." class="yt-search-input">
            <button class="admin-btn admin-btn-green" onclick="searchYoutube()">üîç –®—É–∫–∞—Ç–∏</button>
          </div>
          <div id="yt-search-results" class="yt-search-results">
            <p class="yt-placeholder">–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É –≤—ñ–¥–µ–æ</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
/* Admin Auth */
.admin-auth {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 60vh;
}
.auth-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 3rem;
  text-align: center;
  max-width: 400px;
  width: 100%;
}
.auth-card h1 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}
.auth-card p {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}
.auth-input {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 1rem;
  margin-bottom: 1rem;
  outline: none;
  transition: border-color var(--transition);
}
.auth-input:focus {
  border-color: var(--green-accent);
}
.auth-btn {
  width: 100%;
  padding: 0.75rem;
  background: var(--green-accent);
  color: #000;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition);
}
.auth-btn:hover {
  background: var(--green-hover);
}
.auth-error {
  color: #ef4444;
  margin-top: 1rem;
  font-size: 0.875rem;
}

/* Admin Panel */
.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.admin-header h1 {
  font-size: 1.5rem;
}
.admin-actions-top {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.admin-btn {
  padding: 0.5rem 1rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.admin-btn:hover {
  border-color: var(--border-hover);
  background: var(--bg-elevated);
}
.admin-btn-green {
  background: var(--green-dim);
  border-color: var(--green-accent);
  color: var(--green-accent);
}
.admin-btn-green:hover {
  background: var(--green-accent);
  color: #000;
}
.admin-btn-dim {
  color: var(--text-secondary);
}
.admin-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Status bar */
.admin-status {
  padding: 0.75rem 1rem;
  border-radius: var(--radius-sm);
  margin-bottom: 1.5rem;
  font-size: 0.875rem;
  animation: fadeIn 0.3s;
}
.admin-status.info {
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #93c5fd;
}
.admin-status.success {
  background: var(--green-dim);
  border: 1px solid rgba(52, 211, 153, 0.3);
  color: var(--green-accent);
}
.admin-status.error {
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #fca5a5;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Drafts list */
.drafts-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.loading {
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
}
.admin-empty {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-secondary);
}
.admin-empty h2 {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

/* Draft card */
.draft-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color var(--transition);
}
.draft-card:hover {
  border-color: var(--border-hover);
}
.draft-card-inner {
  display: flex;
  gap: 1.5rem;
  padding: 1.25rem;
}
.draft-image {
  width: 160px;
  height: 100px;
  border-radius: var(--radius-sm);
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg-tertiary);
}
.draft-image-placeholder {
  width: 160px;
  height: 100px;
  border-radius: var(--radius-sm);
  background: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  flex-shrink: 0;
}
.draft-info {
  flex: 1;
  min-width: 0;
}
.draft-title {
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 0.35rem;
  line-height: 1.3;
}
.draft-title a {
  color: var(--text-primary);
  text-decoration: none;
}
.draft-title a:hover {
  color: var(--green-accent);
}
.draft-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}
.draft-summary {
  font-size: 0.875rem;
  color: var(--text-secondary);
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.draft-actions {
  display: flex;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  border-top: 1px solid var(--divider);
  background: rgba(0,0,0,0.2);
}
.draft-actions .admin-btn {
  font-size: 0.8rem;
  padding: 0.4rem 0.75rem;
}
.btn-approve {
  background: var(--green-dim) !important;
  border-color: var(--green-accent) !important;
  color: var(--green-accent) !important;
}
.btn-approve:hover {
  background: var(--green-accent) !important;
  color: #000 !important;
}
.btn-delete {
  color: #ef4444 !important;
  border-color: rgba(239, 68, 68, 0.3) !important;
  background: rgba(239, 68, 68, 0.1) !important;
}
.btn-delete:hover {
  background: #ef4444 !important;
  color: #fff !important;
}

/* GitHub PAT setup */
.pat-setup {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}
.pat-setup h3 {
  font-size: 1rem;
  margin-bottom: 0.5rem;
}
.pat-setup p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}
.pat-input-row {
  display: flex;
  gap: 0.5rem;
}
.pat-input-row input {
  flex: 1;
  padding: 0.5rem 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  outline: none;
}
.pat-input-row input:focus {
  border-color: var(--green-accent);
}

/* Deploy queue */
.deploy-queue {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 2px solid var(--green-accent);
}
.deploy-queue-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1rem;
}
.deploy-queue-header h2 {
  font-size: 1.15rem;
  color: var(--green-accent);
}
.deploy-queue-actions {
  display: flex;
  gap: 0.5rem;
}
.queue-items {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.queue-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.6rem 1rem;
  background: var(--green-subtle);
  border: 1px solid rgba(52, 211, 153, 0.15);
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
}
.queue-item-title {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--text-primary);
}
.queue-item-cat {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-left: 1rem;
  flex-shrink: 0;
}
.queue-item-remove {
  margin-left: 0.75rem;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.8rem;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  flex-shrink: 0;
}
.queue-item-remove:hover {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

/* Telegram queue styling */
.tg-queue {
  border-top-color: #0088cc !important;
}
.tg-queue .deploy-queue-header h2 {
  color: #0088cc;
}
.admin-btn-tg {
  background: rgba(0, 136, 204, 0.15) !important;
  border-color: #0088cc !important;
  color: #0088cc !important;
}
.admin-btn-tg:hover {
  background: #0088cc !important;
  color: #fff !important;
}

/* YouTube search */
.yt-field-row {
  display: flex;
  gap: 0.4rem;
}
.yt-field-row input {
  flex: 1;
}
.admin-btn-yt-search {
  background: rgba(255, 0, 0, 0.12) !important;
  border-color: #c00 !important;
  color: #f44 !important;
  font-size: 0.8rem !important;
  padding: 0.4rem 0.6rem !important;
  white-space: nowrap;
}
.admin-btn-yt-search:hover {
  background: #c00 !important;
  color: #fff !important;
}
.yt-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}
.yt-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
}
.yt-modal-content {
  position: relative;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  width: 90%;
  max-width: 700px;
  max-height: 80vh;
  overflow-y: auto;
}
.yt-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.yt-modal-header h2 {
  font-size: 1.15rem;
  color: #f44;
}
.yt-search-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}
.yt-search-input {
  flex: 1;
  padding: 0.6rem 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.9rem;
  outline: none;
}
.yt-search-input:focus {
  border-color: #f44;
}
.yt-search-results {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.yt-placeholder {
  text-align: center;
  color: var(--text-secondary);
  padding: 2rem;
}
.yt-result {
  display: flex;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
}
.yt-result:hover {
  border-color: #f44;
  background: rgba(255, 0, 0, 0.05);
}
.yt-result-thumb {
  width: 160px;
  height: 90px;
  border-radius: 4px;
  object-fit: cover;
  flex-shrink: 0;
}
.yt-result-info {
  flex: 1;
  min-width: 0;
}
.yt-result-title {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
  color: var(--text-primary);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.yt-result-channel {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.2rem;
}
.yt-result-date {
  font-size: 0.75rem;
  color: var(--text-tertiary);
}

/* Scheduler UI */
.schedule-row {
  display: flex;
  gap: 0.4rem;
  align-items: center;
}
.schedule-input {
  padding: 0.4rem 0.6rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.8rem;
  outline: none;
  transition: border-color var(--transition);
}
.schedule-input:focus {
  border-color: #f59e0b;
}
.admin-btn-schedule {
  background: rgba(245, 158, 11, 0.15) !important;
  border-color: #f59e0b !important;
  color: #f59e0b !important;
  font-size: 0.8rem !important;
  padding: 0.4rem 0.6rem !important;
}
.admin-btn-schedule:hover {
  background: #f59e0b !important;
  color: #000 !important;
}
.scheduled-items {
  margin-top: 0.75rem;
}
.scheduled-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0.75rem;
  background: rgba(245, 158, 11, 0.08);
  border: 1px solid rgba(245, 158, 11, 0.2);
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  margin-bottom: 0.4rem;
}
.scheduled-item-info {
  flex: 1;
  min-width: 0;
  color: #f59e0b;
}
.scheduled-item-time {
  font-weight: 600;
  margin-right: 0.5rem;
}
.scheduled-item-count {
  color: var(--text-secondary);
}
.scheduled-item-cancel {
  margin-left: 0.5rem;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.8rem;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  flex-shrink: 0;
}
.scheduled-item-cancel:hover {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

/* UA pipeline button styling */
.admin-btn-ua {
  background: rgba(0, 87, 183, 0.15) !important;
  border-color: #0057B7 !important;
  color: #FFD700 !important;
  font-weight: 600;
}
.admin-btn-ua:hover {
  background: #0057B7 !important;
  color: #FFD700 !important;
}

/* Threads queue styling */
.threads-queue {
  border-top-color: #833AB4 !important;
}
.threads-queue .deploy-queue-header h2 {
  color: #833AB4;
}
.admin-btn-threads {
  background: rgba(131, 58, 180, 0.15) !important;
  border-color: #833AB4 !important;
  color: #833AB4 !important;
}
.admin-btn-threads:hover {
  background: #833AB4 !important;
  color: #fff !important;
}

/* Create article form */
.create-form {
  margin-bottom: 2rem;
}
.create-form-card {
  background: var(--bg-secondary);
  border: 1px solid var(--green-accent);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
}
.create-form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.25rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.create-form-header h2 {
  font-size: 1.15rem;
  color: var(--green-accent);
}
.cf-row {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}
.cf-field {
  flex: 1;
  min-width: 0;
}
.cf-field-wide {
  flex: 1 1 100%;
}
.cf-field label {
  display: block;
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.35rem;
  font-weight: 500;
}
.cf-field input,
.cf-field textarea,
.cf-field select {
  width: 100%;
  padding: 0.55rem 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  outline: none;
  transition: border-color var(--transition);
  font-family: inherit;
}
.cf-field input:focus,
.cf-field textarea:focus,
.cf-field select:focus {
  border-color: var(--green-accent);
}
.cf-field select {
  cursor: pointer;
}
.cf-field select option {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}
.cf-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}
.cf-submit-btn {
  font-size: 0.95rem !important;
  padding: 0.65rem 1.5rem !important;
}

/* Quill editor overrides for dark theme */
#cf-editor {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  min-height: 250px;
}
.ql-toolbar.ql-snow {
  background: var(--bg-elevated) !important;
  border: none !important;
  border-bottom: 1px solid var(--border) !important;
  border-radius: var(--radius-sm) var(--radius-sm) 0 0 !important;
}
.ql-container.ql-snow {
  border: none !important;
  font-size: 0.95rem;
  font-family: inherit;
  color: var(--text-primary);
}
.ql-editor {
  min-height: 200px;
  color: var(--text-primary) !important;
  line-height: 1.6;
}
.ql-editor.ql-blank::before {
  color: var(--text-tertiary) !important;
  font-style: normal !important;
}
.ql-snow .ql-stroke {
  stroke: var(--text-secondary) !important;
}
.ql-snow .ql-fill,
.ql-snow .ql-stroke.ql-fill {
  fill: var(--text-secondary) !important;
}
.ql-snow .ql-picker-label {
  color: var(--text-secondary) !important;
}
.ql-snow .ql-picker-options {
  background: var(--bg-tertiary) !important;
  border-color: var(--border) !important;
}
.ql-snow .ql-picker-item {
  color: var(--text-primary) !important;
}
.ql-snow .ql-active .ql-stroke {
  stroke: var(--green-accent) !important;
}
.ql-snow .ql-active .ql-fill {
  fill: var(--green-accent) !important;
}
.ql-snow .ql-active {
  color: var(--green-accent) !important;
}
.ql-snow a {
  color: var(--green-accent) !important;
}
.ql-editor blockquote {
  border-left: 3px solid var(--green-accent);
  padding-left: 12px;
  color: var(--text-secondary);
}

/* Responsive */
@media (max-width: 640px) {
  .draft-card-inner {
    flex-direction: column;
    gap: 1rem;
  }
  .draft-image, .draft-image-placeholder {
    width: 100%;
    height: 180px;
  }
  .admin-header {
    flex-direction: column;
    align-items: flex-start;
  }
  .admin-actions-top {
    width: 100%;
  }
  .admin-actions-top .admin-btn {
    flex: 1;
    text-align: center;
  }
  .deploy-queue-actions {
    flex-direction: column;
    width: 100%;
  }
  .schedule-row {
    flex-wrap: wrap;
  }
  .schedule-input {
    flex: 1;
    min-width: 150px;
  }
  .cf-row {
    flex-direction: column;
  }
  .create-form-card {
    padding: 1rem;
  }
}
</style>

<script>
(function() {
  'use strict';

  var ADMIN_KEY_HASH = '{{ .Site.Params.admin_key_hash }}';
  var GITHUB_REPO = '{{ .Site.Params.github_repo }}';
  var SITE_URL = '{{ .Site.BaseURL }}';

  var ghToken = '';
  var adminKey = '';
  var approvedQueue = [];
  var telegramQueue = [];
  var threadsQueue = [];

  // =========================================================================
  // Auth
  // =========================================================================

  function init() {
    // Check URL param
    var params = new URLSearchParams(window.location.search);
    var key = params.get('key');
    if (key) {
      checkAuth(key);
      return;
    }

    // Check localStorage
    var saved = localStorage.getItem('konopla_admin_key');
    if (saved) {
      checkAuth(saved);
      return;
    }

    showAuth();
  }

  function showAuth() {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('admin-panel').style.display = 'none';
  }

  function showPanel() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';

    // Load GitHub PAT from localStorage
    ghToken = localStorage.getItem('konopla_gh_token') || '';

    // Load queues from localStorage
    loadQueue();
    renderQueue();
    loadTgQueue();
    renderTgQueue();
    loadThreadsQueue();
    renderThreadsQueue();

    // Load scheduled items (async, non-blocking)
    if (ghToken) {
      loadScheduledItems();
    }

    if (!ghToken) {
      showPatSetup();
    } else {
      loadDrafts();
    }
  }

  async function checkAuth(key) {
    var hash = await sha256(key);
    if (hash === ADMIN_KEY_HASH) {
      adminKey = key;
      localStorage.setItem('konopla_admin_key', key);
      // Clean URL
      if (window.location.search) {
        window.history.replaceState({}, '', window.location.pathname);
      }
      showPanel();
    } else {
      localStorage.removeItem('konopla_admin_key');
      showAuth();
      document.getElementById('auth-error').style.display = 'block';
    }
  }

  function logout() {
    localStorage.removeItem('konopla_admin_key');
    localStorage.removeItem('konopla_gh_token');
    adminKey = '';
    ghToken = '';
    showAuth();
  }

  async function sha256(str) {
    var buf = new TextEncoder().encode(str);
    var hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
  }

  // Auth form handler
  document.getElementById('auth-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var key = document.getElementById('auth-key').value.trim();
    if (key) checkAuth(key);
  });

  // =========================================================================
  // GitHub PAT setup
  // =========================================================================

  function showPatSetup() {
    var el = document.getElementById('drafts-list');
    el.innerHTML = '<div class="pat-setup">' +
      '<h3>üîë GitHub Token</h3>' +
      '<p>–î–ª—è –º–æ–¥–µ—Ä–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–µ–Ω GitHub Personal Access Token (fine-grained) –∑ –ø—Ä–∞–≤–∞–º–∏ <code>contents:write</code> —Ç–∞ <code>actions:write</code> –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é <code>' + GITHUB_REPO + '</code>.</p>' +
      '<div class="pat-input-row">' +
        '<input type="password" id="pat-input" placeholder="github_pat_...">' +
        '<button class="admin-btn admin-btn-green" onclick="saveToken()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>' +
      '</div>' +
    '</div>';
  }

  window.saveToken = function() {
    var token = document.getElementById('pat-input').value.trim();
    if (!token) return;
    ghToken = token;
    localStorage.setItem('konopla_gh_token', token);
    showStatus('Token –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
    loadDrafts();
  };

  // =========================================================================
  // Load drafts
  // =========================================================================

  window.loadDrafts = async function() {
    if (!ghToken) {
      showPatSetup();
      return;
    }

    var el = document.getElementById('drafts-list');
    el.innerHTML = '<div class="loading">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
    document.getElementById('empty-state').style.display = 'none';

    try {
      // Fetch drafts.json from repo
      var resp = await ghApi('GET', '/contents/data/drafts.json');

      if (resp.status === 404) {
        el.innerHTML = '';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      if (!resp.ok) throw new Error('GitHub API error: ' + resp.status);

      var data = await resp.json();
      var content = JSON.parse(b64DecodeUtf8(data.content));
      var articles = (content.articles || []).filter(function(a) { return a && a.filename; });

      if (articles.length === 0) {
        el.innerHTML = '';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      // Sort newest first
      articles.sort(function(a, b) {
        return (b.created_at || '').localeCompare(a.created_at || '');
      });

      el.innerHTML = articles.map(function(a) {
        var img = a.image
          ? '<img src="' + escHtml(a.image) + '" alt="" class="draft-image">'
          : '<div class="draft-image-placeholder">üì∞</div>';

        var cat = a.category || '';
        var date = a.created_at ? new Date(a.created_at).toLocaleString('uk-UA') : '';

        return '<div class="draft-card" data-filename="' + escHtml(a.filename) + '" data-id="' + escHtml(a.id) + '">' +
          '<div class="draft-card-inner">' +
            img +
            '<div class="draft-info">' +
              '<h3 class="draft-title"><a href="/news/' + escHtml(a.filename.replace('.md', '')) + '/" target="_blank">' + escHtml(a.title) + '</a></h3>' +
              '<div class="draft-meta"><span>' + escHtml(cat) + '</span><span>' + escHtml(date) + '</span></div>' +
              '<p class="draft-summary">' + escHtml(a.summary || '') + '</p>' +
            '</div>' +
          '</div>' +
          '<div class="draft-actions">' +
            '<button class="admin-btn btn-approve" onclick="approveArticle(\'' + escHtml(a.filename) + '\', \'' + escHtml(a.id) + '\')">‚úÖ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>' +
            '<button class="admin-btn btn-delete" onclick="deleteArticle(\'' + escHtml(a.filename) + '\', \'' + escHtml(a.id) + '\')">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏</button>' +
            '<a href="/news/' + escHtml(a.filename.replace('.md', '')) + '/" target="_blank" class="admin-btn">üëÅ Preview</a>' +
          '</div>' +
        '</div>';
      }).join('');

    } catch (e) {
      console.error('Load error:', e);
      el.innerHTML = '<div class="loading">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + escHtml(e.message) + '</div>';

      if (e.message && e.message.indexOf('401') !== -1) {
        localStorage.removeItem('konopla_gh_token');
        ghToken = '';
        showPatSetup();
      }
    }
  };

  // =========================================================================
  // Approve article: change draft:true ‚Üí draft:false
  // =========================================================================

  window.approveArticle = async function(filename, articleId) {
    if (!confirm('–°—Ö–≤–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é?')) return;

    var card = document.querySelector('[data-filename="' + filename + '"]');
    // Get title from card before disabling
    var titleEl = card ? card.querySelector('.draft-title a') : null;
    var title = titleEl ? titleEl.textContent : filename;
    var catEl = card ? card.querySelector('.draft-meta span') : null;
    var category = catEl ? catEl.textContent : '';

    disableCard(card);
    showStatus('‚è≥ –°—Ö–≤–∞–ª—é—î–º–æ...', 'info');

    try {
      // 1. Get the .md file
      var fileResp = await ghApi('GET', '/contents/content/news/' + filename);
      if (!fileResp.ok) throw new Error('Cannot fetch file: ' + fileResp.status);
      var fileData = await fileResp.json();

      // 2. Decode content, replace draft: true ‚Üí draft: false
      var decoded = b64DecodeUtf8(fileData.content);
      var updated = decoded.replace(/^draft:\s*true$/m, 'draft: false');

      if (updated === decoded) {
        showStatus('‚ö†Ô∏è –§–∞–π–ª –≤–∂–µ –Ω–µ draft –∞–±–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ draft: true', 'error');
        enableCard(card);
        return;
      }

      // 3. PUT updated file back
      var putResp = await ghApi('PUT', '/contents/content/news/' + filename, {
        message: '‚úÖ Approve: ' + filename,
        content: b64EncodeUtf8(updated),
        sha: fileData.sha
      });

      if (!putResp.ok) {
        var err = await putResp.json().catch(function() { return {}; });
        throw new Error('PUT failed: ' + (err.message || putResp.status));
      }

      // 4. Remove from drafts.json
      await removeDraftEntry(articleId);

      // 5. Add to deploy queue AND telegram queue
      var queueItem = {
        title: title,
        filename: filename,
        category: category,
        approvedAt: new Date().toISOString()
      };
      approvedQueue.push(queueItem);
      saveQueue();
      renderQueue();

      telegramQueue.push(queueItem);
      saveTgQueue();
      renderTgQueue();

      threadsQueue.push(queueItem);
      saveThreadsQueue();
      renderThreadsQueue();

      showStatus('‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ! –î–æ–¥–∞–Ω–æ –≤ —á–µ—Ä–≥–∏ –¥–µ–ø–ª–æ–π + Telegram + Threads.', 'success');

      // Remove card from UI
      if (card) card.remove();

      // Check if list is empty
      var remaining = document.querySelectorAll('.draft-card');
      if (remaining.length === 0) {
        document.getElementById('empty-state').style.display = 'block';
      }

    } catch (e) {
      console.error('Approve error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
      enableCard(card);
    }
  };

  // =========================================================================
  // Delete article
  // =========================================================================

  window.deleteArticle = async function(filename, articleId) {
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;

    var card = document.querySelector('[data-filename="' + filename + '"]');
    disableCard(card);
    showStatus('‚è≥ –í–∏–¥–∞–ª—è—î–º–æ...', 'info');

    try {
      // 1. Get file SHA
      var fileResp = await ghApi('GET', '/contents/content/news/' + filename);
      if (!fileResp.ok && fileResp.status !== 404) throw new Error('Cannot fetch file: ' + fileResp.status);

      if (fileResp.ok) {
        var fileData = await fileResp.json();

        // 2. Delete file
        var delResp = await ghApi('DELETE', '/contents/content/news/' + filename, {
          message: '‚ùå Delete: ' + filename,
          sha: fileData.sha
        });

        if (!delResp.ok) {
          var err = await delResp.json().catch(function() { return {}; });
          throw new Error('DELETE failed: ' + (err.message || delResp.status));
        }
      }

      // 3. Remove from drafts.json
      await removeDraftEntry(articleId);

      showStatus('üóëÔ∏è –°—Ç–∞—Ç—Ç—è –≤–∏–¥–∞–ª–µ–Ω–∞.', 'success');

      if (card) card.remove();

      var remaining = document.querySelectorAll('.draft-card');
      if (remaining.length === 0) {
        document.getElementById('empty-state').style.display = 'block';
      }

    } catch (e) {
      console.error('Delete error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
      enableCard(card);
    }
  };

  // =========================================================================
  // Run pipeline
  // =========================================================================

  window.runPipeline = async function() {
    if (!ghToken) {
      showStatus('‚ùå –ü–æ—Ç—Ä—ñ–±–µ–Ω GitHub Token', 'error');
      return;
    }

    showStatus('‚è≥ –ó–∞–ø—É—Å–∫ pipeline...', 'info');
    document.getElementById('btn-run-pipeline').disabled = true;

    try {
      var resp = await ghApi('POST', '/actions/workflows/pipeline.yml/dispatches', {
        ref: 'main'
      });

      if (resp.status === 204 || resp.ok) {
        showStatus('üöÄ Pipeline –∑–∞–ø—É—â–µ–Ω–æ! –ù–æ–≤—ñ —Å—Ç–∞—Ç—Ç—ñ –∑\'—è–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω.', 'success');
      } else {
        throw new Error('Status: ' + resp.status);
      }
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É: ' + e.message, 'error');
    }

    setTimeout(function() {
      document.getElementById('btn-run-pipeline').disabled = false;
    }, 10000);
  };

  // =========================================================================
  // Run UA pipeline
  // =========================================================================

  window.runUaPipeline = async function() {
    if (!ghToken) {
      showStatus('‚ùå –ü–æ—Ç—Ä—ñ–±–µ–Ω GitHub Token', 'error');
      return;
    }

    showStatus('‚è≥ –ó–∞–ø—É—Å–∫ UA pipeline...', 'info');
    document.getElementById('btn-ua-pipeline').disabled = true;

    try {
      var resp = await ghApi('POST', '/actions/workflows/ua_pipeline.yml/dispatches', {
        ref: 'main'
      });

      if (resp.status === 204 || resp.ok) {
        showStatus('üá∫üá¶ UA Pipeline –∑–∞–ø—É—â–µ–Ω–æ! –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ –Ω–æ–≤–∏–Ω–∏ –∑\'—è–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω.', 'success');
      } else {
        throw new Error('Status: ' + resp.status);
      }
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É UA pipeline: ' + e.message, 'error');
    }

    setTimeout(function() {
      document.getElementById('btn-ua-pipeline').disabled = false;
    }, 10000);
  };

  // =========================================================================
  // Helpers
  // =========================================================================

  async function removeDraftEntry(articleId) {
    try {
      var resp = await ghApi('GET', '/contents/data/drafts.json');
      if (!resp.ok) return;

      var data = await resp.json();
      var content = JSON.parse(b64DecodeUtf8(data.content));

      content.articles = (content.articles || []).filter(function(a) {
        return a.id !== articleId;
      });

      var encoded = b64EncodeUtf8(JSON.stringify(content, null, 2));

      await ghApi('PUT', '/contents/data/drafts.json', {
        message: 'üìã Update drafts.json',
        content: encoded,
        sha: data.sha
      });
    } catch (e) {
      console.warn('Failed to update drafts.json:', e);
    }
  }

  // =========================================================================
  // Deploy queue
  // =========================================================================

  function loadQueue() {
    try {
      var saved = localStorage.getItem('konopla_deploy_queue');
      approvedQueue = saved ? JSON.parse(saved) : [];
    } catch (e) {
      approvedQueue = [];
    }
  }

  function saveQueue() {
    localStorage.setItem('konopla_deploy_queue', JSON.stringify(approvedQueue));
  }

  function renderQueue() {
    var container = document.getElementById('deploy-queue');
    var itemsEl = document.getElementById('queue-items');
    var countEl = document.getElementById('queue-count');

    if (!approvedQueue.length) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    countEl.textContent = approvedQueue.length;

    itemsEl.innerHTML = approvedQueue.map(function(item, idx) {
      return '<div class="queue-item">' +
        '<span class="queue-item-title">' + escHtml(item.title) + '</span>' +
        '<span class="queue-item-cat">' + escHtml(item.category || '') + '</span>' +
        '<button class="queue-item-remove" onclick="removeFromQueue(' + idx + ')" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úï</button>' +
      '</div>';
    }).join('');
  }

  window.removeFromQueue = function(idx) {
    approvedQueue.splice(idx, 1);
    saveQueue();
    renderQueue();
  };

  window.clearQueue = function() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ —á–µ—Ä–≥—É? (–°—Ç–∞—Ç—Ç—ñ –≤–∂–µ —Å—Ö–≤–∞–ª–µ–Ω—ñ, –∞–ª–µ –¥–µ–ø–ª–æ–π –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è)')) return;
    approvedQueue = [];
    saveQueue();
    renderQueue();
  };

  window.deployAll = async function() {
    if (!approvedQueue.length) return;
    if (!confirm('–ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ ' + approvedQueue.length + ' —Å—Ç–∞—Ç–µ–π?')) return;

    showStatus('‚è≥ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—é...', 'info');

    try {
      await triggerDeploy();
      var count = approvedQueue.length;
      approvedQueue = [];
      saveQueue();
      renderQueue();
      showStatus('üöÄ –î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω–æ! ' + count + ' —Å—Ç–∞—Ç–µ–π –∑\'—è–≤–ª—è—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç—ñ –∑–∞ 1-2 —Ö–≤.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–µ–ø–ª–æ—é: ' + e.message, 'error');
    }
  };

  async function triggerDeploy() {
    try {
      await ghApi('POST', '/actions/workflows/moderate.yml/dispatches', {
        ref: 'main'
      });
    } catch (e) {
      console.warn('Failed to trigger deploy:', e);
    }
  }

  // =========================================================================
  // Telegram queue
  // =========================================================================

  function loadTgQueue() {
    try {
      var saved = localStorage.getItem('konopla_tg_queue');
      telegramQueue = saved ? JSON.parse(saved) : [];
    } catch (e) {
      telegramQueue = [];
    }
  }

  function saveTgQueue() {
    localStorage.setItem('konopla_tg_queue', JSON.stringify(telegramQueue));
  }

  function renderTgQueue() {
    var container = document.getElementById('tg-queue');
    var itemsEl = document.getElementById('tg-queue-items');
    var countEl = document.getElementById('tg-queue-count');

    if (!telegramQueue.length) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    countEl.textContent = telegramQueue.length;

    itemsEl.innerHTML = telegramQueue.map(function(item, idx) {
      return '<div class="queue-item">' +
        '<span class="queue-item-title">' + escHtml(item.title) + '</span>' +
        '<span class="queue-item-cat">' + escHtml(item.category || '') + '</span>' +
        '<button class="queue-item-remove" onclick="removeFromTgQueue(' + idx + ')" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úï</button>' +
      '</div>';
    }).join('');
  }

  window.removeFromTgQueue = function(idx) {
    telegramQueue.splice(idx, 1);
    saveTgQueue();
    renderTgQueue();
  };

  window.clearTgQueue = function() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ Telegram —á–µ—Ä–≥—É?')) return;
    telegramQueue = [];
    saveTgQueue();
    renderTgQueue();
  };

  window.postToTelegram = async function() {
    if (!telegramQueue.length) return;
    if (!confirm('–ü–æ—Å—Ç–∏—Ç–∏ ' + telegramQueue.length + ' —Å—Ç–∞—Ç–µ–π –≤ Telegram?')) return;

    showStatus('‚è≥ –ì–æ—Ç—É—î–º–æ Telegram –ø–æ—Å—Ç–∏–Ω–≥...', 'info');

    try {
      // 1. Write telegram_queue.json to repo
      var queueData = {
        articles: telegramQueue.map(function(item) {
          return { filename: item.filename, title: item.title, category: item.category };
        })
      };

      // Get current file to get SHA (or handle 404 for new file)
      var getResp = await ghApi('GET', '/contents/data/telegram_queue.json');
      var sha = null;
      if (getResp.ok) {
        var existing = await getResp.json();
        sha = existing.sha;
      }

      var putBody = {
        message: 'üì® Telegram queue: ' + telegramQueue.length + ' articles',
        content: b64EncodeUtf8(JSON.stringify(queueData, null, 2))
      };
      if (sha) putBody.sha = sha;

      var putResp = await ghApi('PUT', '/contents/data/telegram_queue.json', putBody);
      if (!putResp.ok) throw new Error('Failed to write queue: ' + putResp.status);

      // 2. Wait for GitHub to process the commit before triggering workflow
      showStatus('‚è≥ –ß–µ–∫–∞—î–º–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é GitHub...', 'info');
      await new Promise(function(r) { setTimeout(r, 5000); });

      // 3. Trigger telegram_post.yml workflow
      await ghApi('POST', '/actions/workflows/telegram_post.yml/dispatches', {
        ref: 'main'
      });

      var count = telegramQueue.length;
      telegramQueue = [];
      saveTgQueue();
      renderTgQueue();
      showStatus('üì® Telegram –ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω–æ! ' + count + ' —Å—Ç–∞—Ç–µ–π.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  // =========================================================================
  // Threads queue
  // =========================================================================

  function loadThreadsQueue() {
    try {
      var saved = localStorage.getItem('konopla_threads_queue');
      threadsQueue = saved ? JSON.parse(saved) : [];
    } catch (e) {
      threadsQueue = [];
    }
  }

  function saveThreadsQueue() {
    localStorage.setItem('konopla_threads_queue', JSON.stringify(threadsQueue));
  }

  function renderThreadsQueue() {
    var container = document.getElementById('threads-queue');
    var itemsEl = document.getElementById('threads-queue-items');
    var countEl = document.getElementById('threads-queue-count');

    if (!threadsQueue.length) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    countEl.textContent = threadsQueue.length;

    itemsEl.innerHTML = threadsQueue.map(function(item, idx) {
      return '<div class="queue-item">' +
        '<span class="queue-item-title">' + escHtml(item.title) + '</span>' +
        '<span class="queue-item-cat">' + escHtml(item.category || '') + '</span>' +
        '<button class="queue-item-remove" onclick="removeFromThreadsQueue(' + idx + ')" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úï</button>' +
      '</div>';
    }).join('');
  }

  window.removeFromThreadsQueue = function(idx) {
    threadsQueue.splice(idx, 1);
    saveThreadsQueue();
    renderThreadsQueue();
  };

  window.clearThreadsQueue = function() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ Threads —á–µ—Ä–≥—É?')) return;
    threadsQueue = [];
    saveThreadsQueue();
    renderThreadsQueue();
  };

  window.postToThreads = async function() {
    if (!threadsQueue.length) return;
    if (!confirm('–ü–æ—Å—Ç–∏—Ç–∏ ' + threadsQueue.length + ' —Å—Ç–∞—Ç–µ–π –≤ Threads?')) return;

    showStatus('‚è≥ –ì–æ—Ç—É—î–º–æ Threads –ø–æ—Å—Ç–∏–Ω–≥...', 'info');

    try {
      // 1. Write threads_queue.json to repo
      var queueData = {
        articles: threadsQueue.map(function(item) {
          return { filename: item.filename, title: item.title, category: item.category };
        })
      };

      // Get current file to get SHA (or handle 404 for new file)
      var getResp = await ghApi('GET', '/contents/data/threads_queue.json');
      var sha = null;
      if (getResp.ok) {
        var existing = await getResp.json();
        sha = existing.sha;
      }

      var putBody = {
        message: 'üßµ Threads queue: ' + threadsQueue.length + ' articles',
        content: b64EncodeUtf8(JSON.stringify(queueData, null, 2))
      };
      if (sha) putBody.sha = sha;

      var putResp = await ghApi('PUT', '/contents/data/threads_queue.json', putBody);
      if (!putResp.ok) throw new Error('Failed to write queue: ' + putResp.status);

      // 2. Wait for GitHub to process the commit before triggering workflow
      showStatus('‚è≥ –ß–µ–∫–∞—î–º–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é GitHub...', 'info');
      await new Promise(function(r) { setTimeout(r, 5000); });

      // 3. Trigger threads_post.yml workflow
      await ghApi('POST', '/actions/workflows/threads_post.yml/dispatches', {
        ref: 'main'
      });

      var count = threadsQueue.length;
      threadsQueue = [];
      saveThreadsQueue();
      renderThreadsQueue();
      showStatus('üßµ Threads –ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω–æ! ' + count + ' —Å—Ç–∞—Ç–µ–π.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  // =========================================================================
  // Scheduler
  // =========================================================================

  window.scheduleAction = async function(type) {
    var inputId = 'schedule-' + type + '-time';
    var input = document.getElementById(inputId);
    if (!input || !input.value) {
      showStatus('‚ùå –û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É —Ç–∞ —á–∞—Å', 'error');
      return;
    }

    // Get the queue items based on type
    var queue;
    if (type === 'deploy') queue = approvedQueue;
    else if (type === 'telegram') queue = telegramQueue;
    else if (type === 'threads') queue = threadsQueue;

    if (!queue || !queue.length) {
      showStatus('‚ùå –ß–µ—Ä–≥–∞ –ø–æ—Ä–æ–∂–Ω—è ‚Äî –Ω–µ–º–∞—î —â–æ –ø–ª–∞–Ω—É–≤–∞—Ç–∏', 'error');
      return;
    }

    // Convert local datetime to UTC ISO
    var localDate = new Date(input.value);
    var scheduledAt = localDate.toISOString();

    if (localDate <= new Date()) {
      showStatus('‚ùå –ß–∞—Å –º–∞—î –±—É—Ç–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É', 'error');
      return;
    }

    var typeLabels = { deploy: '–¥–µ–ø–ª–æ–π', telegram: 'Telegram', threads: 'Threads' };
    if (!confirm('–ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ ' + typeLabels[type] + ' –Ω–∞ ' + localDate.toLocaleString('uk-UA') + '?')) return;

    showStatus('‚è≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–æ–∑–∫–ª–∞–¥...', 'info');

    try {
      // Read current scheduled.json from repo
      var getResp = await ghApi('GET', '/contents/data/scheduled.json');
      var sha = null;
      var scheduled = { deploy: [], telegram: [], threads: [] };

      if (getResp.ok) {
        var fileData = await getResp.json();
        sha = fileData.sha;
        scheduled = JSON.parse(b64DecodeUtf8(fileData.content));
      }

      // Create scheduled item
      var schedItem = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        articles: queue.map(function(item) {
          return { filename: item.filename, title: item.title, category: item.category };
        }),
        scheduled_at: scheduledAt,
        created_at: new Date().toISOString()
      };

      if (!scheduled[type]) scheduled[type] = [];
      scheduled[type].push(schedItem);

      // Write back to repo
      var putBody = {
        message: '‚è∞ Schedule ' + type + ': ' + localDate.toLocaleString('uk-UA'),
        content: b64EncodeUtf8(JSON.stringify(scheduled, null, 2))
      };
      if (sha) putBody.sha = sha;

      var putResp = await ghApi('PUT', '/contents/data/scheduled.json', putBody);
      if (!putResp.ok) throw new Error('Failed to save schedule: ' + putResp.status);

      // Clear the queue (items are now scheduled)
      if (type === 'deploy') { approvedQueue = []; saveQueue(); renderQueue(); }
      else if (type === 'telegram') { telegramQueue = []; saveTgQueue(); renderTgQueue(); }
      else if (type === 'threads') { threadsQueue = []; saveThreadsQueue(); renderThreadsQueue(); }

      // Reset input
      input.value = '';

      // Reload scheduled items display
      loadScheduledItems();

      showStatus('‚è∞ ' + typeLabels[type] + ' –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –Ω–∞ ' + localDate.toLocaleString('uk-UA') + '!', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è: ' + e.message, 'error');
    }
  };

  window.cancelScheduled = async function(type, itemId) {
    if (!confirm('–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—É –¥—ñ—é?')) return;

    showStatus('‚è≥ –°–∫–∞—Å–æ–≤—É—î–º–æ...', 'info');

    try {
      var getResp = await ghApi('GET', '/contents/data/scheduled.json');
      if (!getResp.ok) throw new Error('Cannot read scheduled.json');

      var fileData = await getResp.json();
      var scheduled = JSON.parse(b64DecodeUtf8(fileData.content));

      if (scheduled[type]) {
        scheduled[type] = scheduled[type].filter(function(item) { return item.id !== itemId; });
      }

      var putBody = {
        message: '‚è∞ Cancel scheduled ' + type,
        content: b64EncodeUtf8(JSON.stringify(scheduled, null, 2)),
        sha: fileData.sha
      };

      var putResp = await ghApi('PUT', '/contents/data/scheduled.json', putBody);
      if (!putResp.ok) throw new Error('Failed to update schedule: ' + putResp.status);

      loadScheduledItems();
      showStatus('‚úÖ –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—É –¥—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  async function loadScheduledItems() {
    try {
      var getResp = await ghApi('GET', '/contents/data/scheduled.json');
      if (!getResp.ok) return;

      var fileData = await getResp.json();
      var scheduled = JSON.parse(b64DecodeUtf8(fileData.content));

      renderScheduledSection('deploy', scheduled.deploy || []);
      renderScheduledSection('telegram', scheduled.telegram || []);
      renderScheduledSection('threads', scheduled.threads || []);
    } catch (e) {
      console.warn('Failed to load scheduled items:', e);
    }
  }

  function renderScheduledSection(type, items) {
    var container = document.getElementById('scheduled-' + type);
    if (!container) return;

    if (!items.length) {
      container.innerHTML = '';
      return;
    }

    var typeEmoji = { deploy: 'üöÄ', telegram: 'üì®', threads: 'üßµ' };

    container.innerHTML = items.map(function(item) {
      var dt = new Date(item.scheduled_at);
      var articlesCount = (item.articles || []).length;
      var titles = (item.articles || []).map(function(a) { return a.title; }).join(', ');

      return '<div class="scheduled-item">' +
        '<div class="scheduled-item-info">' +
          '<span class="scheduled-item-time">' + typeEmoji[type] + ' ' + dt.toLocaleString('uk-UA') + '</span>' +
          '<span class="scheduled-item-count">' + articlesCount + ' —Å—Ç–∞—Ç.' + (titles ? ' ‚Äî ' + escHtml(titles).slice(0, 60) : '') + '</span>' +
        '</div>' +
        '<button class="scheduled-item-cancel" onclick="cancelScheduled(\'' + type + '\', \'' + escHtml(item.id) + '\')" title="–°–∫–∞—Å—É–≤–∞—Ç–∏">‚úï</button>' +
      '</div>';
    }).join('');
  }

  // =========================================================================
  // YouTube Search
  // =========================================================================

  window.openYtSearch = function() {
    // Check for YouTube API key
    var ytKey = localStorage.getItem('konopla_yt_key');
    if (!ytKey) {
      ytKey = prompt('–í–≤–µ–¥—ñ—Ç—å YouTube Data API Key (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ):');
      if (!ytKey) return;
      localStorage.setItem('konopla_yt_key', ytKey);
    }
    document.getElementById('yt-modal').style.display = 'flex';
    document.getElementById('yt-search-input').focus();
  };

  window.closeYtSearch = function() {
    document.getElementById('yt-modal').style.display = 'none';
  };

  window.searchYoutube = async function() {
    var query = document.getElementById('yt-search-input').value.trim();
    if (!query) return;

    var ytKey = localStorage.getItem('konopla_yt_key');
    if (!ytKey) {
      openYtSearch();
      return;
    }

    var resultsEl = document.getElementById('yt-search-results');
    resultsEl.innerHTML = '<p class="yt-placeholder">‚è≥ –ü–æ—à—É–∫...</p>';

    try {
      var url = 'https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&order=date&maxResults=10&relevanceLanguage=uk&q=' + encodeURIComponent(query) + '&key=' + encodeURIComponent(ytKey);

      var resp = await fetch(url);
      if (!resp.ok) {
        if (resp.status === 403 || resp.status === 400) {
          localStorage.removeItem('konopla_yt_key');
          throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π API –∫–ª—é—á. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É.');
        }
        throw new Error('YouTube API error: ' + resp.status);
      }

      var data = await resp.json();
      var items = data.items || [];

      if (!items.length) {
        resultsEl.innerHTML = '<p class="yt-placeholder">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
      }

      resultsEl.innerHTML = items.map(function(item) {
        var vid = item.id.videoId;
        var snippet = item.snippet;
        var thumb = snippet.thumbnails.medium ? snippet.thumbnails.medium.url : '';
        var title = snippet.title;
        var channel = snippet.channelTitle;
        var published = new Date(snippet.publishedAt).toLocaleDateString('uk-UA');

        return '<div class="yt-result" onclick="selectYtVideo(\'' + escHtml(vid) + '\', \'' + escHtml(title.replace(/'/g, '')) + '\')">' +
          '<img class="yt-result-thumb" src="' + escHtml(thumb) + '" alt="">' +
          '<div class="yt-result-info">' +
            '<div class="yt-result-title">' + escHtml(title) + '</div>' +
            '<div class="yt-result-channel">' + escHtml(channel) + '</div>' +
            '<div class="yt-result-date">' + escHtml(published) + '</div>' +
          '</div>' +
        '</div>';
      }).join('');

    } catch (e) {
      resultsEl.innerHTML = '<p class="yt-placeholder">‚ùå ' + escHtml(e.message) + '</p>';
    }
  };

  // Handle Enter key in search input
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.activeElement && document.activeElement.id === 'yt-search-input') {
      e.preventDefault();
      searchYoutube();
    }
  });

  window.selectYtVideo = function(videoId, title) {
    document.getElementById('cf-youtube').value = videoId;

    // Auto-fill title if empty
    var titleInput = document.getElementById('cf-title');
    if (!titleInput.value.trim() && title) {
      titleInput.value = title;
    }

    // Auto-set category to "–≤—ñ–¥–µ–æ"
    document.getElementById('cf-category').value = '–≤—ñ–¥–µ–æ';

    closeYtSearch();
    showStatus('üé¨ –í—ñ–¥–µ–æ –≤–∏–±—Ä–∞–Ω–æ: ' + videoId, 'success');
  };

  // UTF-8 safe base64 decode/encode
  function b64DecodeUtf8(b64) {
    var binStr = atob(b64);
    var bytes = new Uint8Array(binStr.length);
    for (var i = 0; i < binStr.length; i++) {
      bytes[i] = binStr.charCodeAt(i);
    }
    return new TextDecoder('utf-8').decode(bytes);
  }

  function b64EncodeUtf8(str) {
    var bytes = new TextEncoder().encode(str);
    var binStr = '';
    for (var i = 0; i < bytes.length; i++) {
      binStr += String.fromCharCode(bytes[i]);
    }
    return btoa(binStr);
  }

  async function ghApi(method, path, body) {
    var url = 'https://api.github.com/repos/' + GITHUB_REPO + path;
    var opts = {
      method: method,
      headers: {
        'Authorization': 'Bearer ' + ghToken,
        'Accept': 'application/vnd.github+json',
        'X-GitHub-Api-Version': '2022-11-28'
      }
    };
    if (body) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }
    return fetch(url, opts);
  }

  function showStatus(msg, type) {
    var el = document.getElementById('status-bar');
    el.textContent = msg;
    el.className = 'admin-status ' + (type || 'info');
    el.style.display = 'block';

    if (type === 'success') {
      setTimeout(function() {
        el.style.display = 'none';
      }, 5000);
    }
  }

  function escHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  function disableCard(card) {
    if (!card) return;
    card.style.opacity = '0.5';
    card.style.pointerEvents = 'none';
  }

  function enableCard(card) {
    if (!card) return;
    card.style.opacity = '1';
    card.style.pointerEvents = '';
  }

  // =========================================================================
  // Create article (WYSIWYG)
  // =========================================================================

  var quillEditor = null;
  var turndownService = null;

  function initQuill() {
    if (quillEditor) return;
    quillEditor = new Quill('#cf-editor', {
      theme: 'snow',
      placeholder: '–ü–∏—à—ñ—Ç—å —Ç—É—Ç —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ...',
      modules: {
        toolbar: [
          [{ 'header': [2, 3, false] }],
          ['bold', 'italic'],
          ['blockquote'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'image'],
          ['clean']
        ]
      }
    });
    turndownService = new TurndownService({
      headingStyle: 'atx',
      bulletListMarker: '-',
      codeBlockStyle: 'fenced'
    });
    // Keep blockquotes as > in markdown
    turndownService.addRule('blockquote', {
      filter: 'blockquote',
      replacement: function(content) {
        var lines = content.trim().split('\n');
        return '\n' + lines.map(function(l) { return '> ' + l; }).join('\n') + '\n\n';
      }
    });
  }

  window.toggleCreateForm = function() {
    var form = document.getElementById('create-form');
    var visible = form.style.display !== 'none';
    form.style.display = visible ? 'none' : 'block';
    if (!visible) {
      initQuill();
    }
  };

  function slugifyUA(text) {
    var translit = {
      '–∞':'a','–±':'b','–≤':'v','–≥':'h','“ë':'g','–¥':'d','–µ':'e',
      '—î':'ye','–∂':'zh','–∑':'z','–∏':'y','—ñ':'i','—ó':'yi','–π':'y',
      '–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r',
      '—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts','—á':'ch',
      '—à':'sh','—â':'shch','—å':'','—é':'yu','—è':'ya','—ä':'','—ã':'y','—ç':'e'
    };
    var result = '';
    var lower = text.toLowerCase().trim();
    for (var i = 0; i < lower.length; i++) {
      var c = lower[i];
      if (translit[c] !== undefined) {
        result += translit[c];
      } else if (/[a-z0-9]/.test(c)) {
        result += c;
      } else if (c === ' ' || c === '_' || c === '.') {
        result += '-';
      } else if (c === '-') {
        result += '-';
      }
    }
    return result.replace(/-+/g, '-').replace(/^-|-$/g, '').slice(0, 80);
  }

  window.createArticle = async function() {
    var title = document.getElementById('cf-title').value.trim();
    var category = document.getElementById('cf-category').value;
    var tagsRaw = document.getElementById('cf-tags').value.trim();
    var summary = document.getElementById('cf-summary').value.trim();
    var imageUrl = document.getElementById('cf-image').value.trim();
    var youtubeId = document.getElementById('cf-youtube').value.trim();
    var source = document.getElementById('cf-source').value.trim() || 'KONOPLA.UA';
    var sourceUrl = document.getElementById('cf-source-url').value.trim();

    // Validate
    if (!title) { showStatus('‚ùå –í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫', 'error'); return; }
    if (!quillEditor || quillEditor.getText().trim().length < 10) {
      showStatus('‚ùå –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π', 'error'); return;
    }

    // Convert Quill HTML to Markdown
    var html = quillEditor.root.innerHTML;
    var content = turndownService.turndown(html);

    // Build tags array
    var tags = tagsRaw ? tagsRaw.split(',').map(function(t) { return t.trim(); }).filter(Boolean) : [];
    var tagsStr = tags.map(function(t) { return '"' + t.replace(/"/g, "'") + '"'; }).join(', ');

    // Generate filename
    var now = new Date();
    var pad = function(n) { return n.toString().padStart(2, '0'); };
    var datePrefix = now.getUTCFullYear().toString() +
      pad(now.getUTCMonth() + 1) + pad(now.getUTCDate()) + '-' +
      pad(now.getUTCHours()) + pad(now.getUTCMinutes());
    var dateStr = now.toISOString().replace(/\.\d{3}Z$/, '+00:00');
    var slug = slugifyUA(title);
    var filename = datePrefix + '-' + slug + '.md';

    // Build frontmatter
    var fm = '---\n';
    fm += 'title: "' + title.replace(/"/g, "'") + '"\n';
    fm += 'date: ' + dateStr + '\n';
    fm += 'summary: "' + (summary || title).replace(/"/g, "'") + '"\n';
    fm += 'categories: ["' + category + '"]\n';
    fm += 'tags: [' + tagsStr + ']\n';
    fm += 'source: "' + source.replace(/"/g, "'") + '"\n';
    if (sourceUrl) fm += 'source_url: "' + sourceUrl + '"\n';
    if (imageUrl) fm += 'image: "' + imageUrl + '"\n';
    if (youtubeId) fm += 'youtube_id: "' + youtubeId + '"\n';
    fm += 'draft: false\n';
    fm += '---\n\n';
    fm += content + '\n';

    showStatus('‚è≥ –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞—Ç—Ç—é...', 'info');

    try {
      var encoded = b64EncodeUtf8(fm);

      var resp = await ghApi('PUT', '/contents/content/news/' + filename, {
        message: '‚úçÔ∏è Custom article: ' + filename,
        content: encoded
      });

      if (!resp.ok) {
        var err = await resp.json().catch(function() { return {}; });
        throw new Error(err.message || 'PUT failed: ' + resp.status);
      }

      // Add to deploy queue
      approvedQueue.push({
        title: title,
        filename: filename,
        category: category,
        approvedAt: now.toISOString()
      });
      saveQueue();
      renderQueue();

      showStatus('‚úÖ –°—Ç–∞—Ç—Ç—è —Å—Ç–≤–æ—Ä–µ–Ω–∞ —Ç–∞ –¥–æ–¥–∞–Ω–∞ –≤ —á–µ—Ä–≥—É –Ω–∞ –¥–µ–ø–ª–æ–π!', 'success');

      // Reset form
      document.getElementById('cf-title').value = '';
      document.getElementById('cf-tags').value = '';
      document.getElementById('cf-summary').value = '';
      document.getElementById('cf-image').value = '';
      document.getElementById('cf-youtube').value = '';
      document.getElementById('cf-source-url').value = '';
      if (quillEditor) quillEditor.setText('');

      // Hide form
      document.getElementById('create-form').style.display = 'none';

    } catch (e) {
      console.error('Create article error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  // Expose for onclick
  window.logout = logout;

  // Init
  init();

})();
</script>
{{ end }}
