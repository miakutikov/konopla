{{ define "main" }}
<!-- Quill WYSIWYG editor -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/turndown@7.2.0/dist/turndown.js"></script>

<div class="container">
  <div id="admin-app">

    <!-- Auth screen -->
    <div id="auth-screen" class="admin-auth">
      <div class="auth-card">
        <h1>üîê –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <p>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É</p>
        <form id="auth-form">
          <input type="password" id="auth-key" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" class="auth-input">
          <button type="submit" class="auth-btn">–£–≤—ñ–π—Ç–∏</button>
        </form>
        <p id="auth-error" class="auth-error" style="display:none">–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å</p>
      </div>
    </div>

    <!-- Admin panel (hidden until auth) -->
    <div id="admin-panel" style="display:none">
      <div class="admin-header">
        <h1>üåø KONOPLA.UA ‚Äî –ú–æ–¥–µ—Ä–∞—Ü—ñ—è</h1>
        <div class="admin-actions-top">
          <button class="admin-btn" onclick="toggleCreateForm()">‚úçÔ∏è –ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è</button>
          <button id="btn-refresh" class="admin-btn" onclick="loadDrafts()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
          <button id="btn-run-pipeline" class="admin-btn admin-btn-green" onclick="runPipeline()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–±—ñ—Ä</button>
          <button id="btn-yt-panel" class="admin-btn admin-btn-yt" onclick="toggleYtPanel()">üé¨ YouTube</button>
          <button id="btn-logout" class="admin-btn admin-btn-dim" onclick="logout()">–í–∏–π—Ç–∏</button>
        </div>
      </div>

      <div id="status-bar" class="admin-status" style="display:none"></div>

      <!-- Create article form (hidden by default) -->
      <div id="create-form" class="create-form" style="display:none">
        <div class="create-form-card">
          <div class="create-form-header">
            <h2>‚úçÔ∏è –ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è</h2>
            <button class="admin-btn admin-btn-dim" onclick="toggleCreateForm()">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
          </div>

          <div class="cf-row">
            <div class="cf-field cf-field-wide">
              <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
              <input type="text" id="cf-title" maxlength="120" placeholder="–ß—ñ—Ç–∫–∏–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫">
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field">
              <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
              <select id="cf-category">
                <option value="—Ç–µ–∫—Å—Ç–∏–ª—å">üßµ —Ç–µ–∫—Å—Ç–∏–ª—å</option>
                <option value="–±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ">üèóÔ∏è –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ</option>
                <option value="–∞–≥—Ä–æ">üå± –∞–≥—Ä–æ</option>
                <option value="–±—ñ–æ–ø–ª–∞—Å—Ç–∏–∫">‚ôªÔ∏è –±—ñ–æ–ø–ª–∞—Å—Ç–∏–∫</option>
                <option value="—Ö–∞—Ä—á–æ–≤–∞">ü•ó —Ö–∞—Ä—á–æ–≤–∞</option>
                <option value="–∞–≤—Ç–æ–ø—Ä–æ–º">üöó –∞–≤—Ç–æ–ø—Ä–æ–º</option>
                <option value="–µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞">‚ö° –µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞</option>
                <option value="–∫–æ—Å–º–µ—Ç–∏–∫–∞">‚ú® –∫–æ—Å–º–µ—Ç–∏–∫–∞</option>
                <option value="–Ω–∞—É–∫–∞">üî¨ –Ω–∞—É–∫–∞</option>
                <option value="–µ–∫–æ–ª–æ–≥—ñ—è">üåç –µ–∫–æ–ª–æ–≥—ñ—è</option>
                <option value="–±—ñ–∑–Ω–µ—Å">üíº –±—ñ–∑–Ω–µ—Å</option>
                <option value="–∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ">üìã –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ</option>
                <option value="–≤—ñ–¥–µ–æ">üé¨ –≤—ñ–¥–µ–æ</option>
                <option value="—ñ–Ω—à–µ">üì∞ —ñ–Ω—à–µ</option>
              </select>
            </div>
            <div class="cf-field">
              <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É)</label>
              <input type="text" id="cf-tags" placeholder="–∫–æ–Ω–æ–ø–ª—ñ, —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó, –£–∫—Ä–∞—ó–Ω–∞">
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field cf-field-wide">
              <label>–ê–Ω–æ–Ω—Å (summary)</label>
              <textarea id="cf-summary" rows="2" maxlength="300" placeholder="1-2 —Ä–µ—á–µ–Ω–Ω—è –¥–ª—è –∫–∞—Ä—Ç–∫–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π"></textarea>
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field cf-field-wide">
              <label>–¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ *</label>
              <div id="cf-editor"></div>
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field">
              <label>URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
              <input type="text" id="cf-image" placeholder="https://example.com/photo.jpg">
            </div>
            <div class="cf-field">
              <label>YouTube ID</label>
              <input type="text" id="cf-youtube" placeholder="dQw4w9WgXcQ">
            </div>
          </div>

          <div class="cf-row">
            <div class="cf-field">
              <label>–î–∂–µ—Ä–µ–ª–æ</label>
              <input type="text" id="cf-source" placeholder="KONOPLA.UA" value="KONOPLA.UA">
            </div>
            <div class="cf-field">
              <label>URL –¥–∂–µ—Ä–µ–ª–∞</label>
              <input type="text" id="cf-source-url" placeholder="https://konopla.ua">
            </div>
          </div>

          <div class="cf-actions">
            <button id="btn-autoformat" class="admin-btn admin-btn-ai" onclick="autoFormat()">‚ú® –ê–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</button>
            <button id="btn-genimage" class="admin-btn admin-btn-img" onclick="generateImage()">üñºÔ∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</button>
            <button class="admin-btn admin-btn-green cf-submit-btn" onclick="createArticle()">üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é</button>
            <button class="admin-btn admin-btn-dim" onclick="toggleCreateForm()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          </div>
        </div>
      </div>

      <div id="drafts-list" class="drafts-list">
        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      </div>

      <div id="empty-state" class="admin-empty" style="display:none">
        <h2>üì≠ –ù–µ–º–∞—î —Å—Ç–∞—Ç–µ–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó</h2>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–±—ñ—Ä¬ª –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –Ω–æ–≤–∏–Ω</p>
      </div>

      <!-- All articles -->
      <div id="articles-section" class="articles-section">
        <div class="articles-header">
          <h2>üìö –£—Å—ñ —Å—Ç–∞—Ç—Ç—ñ (<span id="articles-count">0</span>)</h2>
          <div class="articles-filters">
            <input type="text" id="articles-search" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é..." oninput="filterArticles()">
            <select id="articles-filter-status" onchange="filterArticles()">
              <option value="all">–£—Å—ñ</option>
              <option value="published">–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω—ñ</option>
              <option value="draft">–ß–µ—Ä–Ω–µ—Ç–∫–∏</option>
            </select>
            <select id="articles-filter-cat" onchange="filterArticles()">
              <option value="all">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
            </select>
          </div>
        </div>
        <div id="articles-list"></div>
      </div>

      <!-- Deploy queue -->
      <div id="deploy-queue" class="deploy-queue" style="display:none">
        <div class="deploy-queue-header">
          <h2>üöÄ –ß–µ—Ä–≥–∞ –Ω–∞ –¥–µ–ø–ª–æ–π</h2>
          <div class="deploy-queue-actions">
            <button class="admin-btn admin-btn-green" onclick="deployAll()">üöÄ –ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ (<span id="queue-count">0</span>)</button>
            <button class="admin-btn admin-btn-dim" onclick="clearQueue()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="queue-items" class="queue-items"></div>
        <div id="scheduled-deploy" class="scheduled-items"></div>
      </div>

      <!-- Telegram queue -->
      <div id="tg-queue" class="deploy-queue tg-queue" style="display:none">
        <div class="deploy-queue-header">
          <h2>üì® –ß–µ—Ä–≥–∞ Telegram</h2>
          <div class="deploy-queue-actions">
            <button class="admin-btn admin-btn-tg" onclick="postToTelegram()">üì® –ü–æ—Å—Ç–∏—Ç–∏ –≤ Telegram (<span id="tg-queue-count">0</span>)</button>
            <button class="admin-btn admin-btn-dim" onclick="clearTgQueue()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="tg-queue-items" class="queue-items"></div>
        <div id="scheduled-telegram" class="scheduled-items"></div>
      </div>

      <!-- Threads queue -->
      <div id="threads-queue" class="deploy-queue threads-queue" style="display:none">
        <div class="deploy-queue-header">
          <h2>üßµ –ß–µ—Ä–≥–∞ Threads</h2>
          <div class="deploy-queue-actions">
            <button class="admin-btn admin-btn-threads" onclick="postToThreads()">üßµ –ü–æ—Å—Ç–∏—Ç–∏ –≤ Threads (<span id="threads-queue-count">0</span>)</button>
            <button class="admin-btn admin-btn-dim" onclick="clearThreadsQueue()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="threads-queue-items" class="queue-items"></div>
        <div id="scheduled-threads" class="scheduled-items"></div>
      </div>

      <!-- YouTube panel (full tab) -->
      <div id="yt-panel" class="yt-panel" style="display:none">
        <div class="yt-panel-header">
          <h2>üé¨ YouTube ‚Äî –ø–æ—à—É–∫ –≤—ñ–¥–µ–æ</h2>
          <button class="admin-btn admin-btn-dim" onclick="toggleYtPanel()">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
        <div class="yt-search-row">
          <input type="text" id="yt-search-input" placeholder="–ü—Ä–æ–º–∏—Å–ª–æ–≤—ñ –∫–æ–Ω–æ–ø–ª—ñ, hemp textile, hempcrete..." class="yt-search-input">
          <button class="admin-btn admin-btn-yt" onclick="ytPanelSearch()">üîç –®—É–∫–∞—Ç–∏</button>
        </div>
        <div id="yt-panel-results" class="yt-panel-results">
          <p class="yt-placeholder">–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É –≤—ñ–¥–µ–æ –ø—Ä–æ –∫–æ–Ω–æ–ø–ª—ñ</p>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
/* Admin Auth */
.admin-auth {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 60vh;
}
.auth-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 3rem;
  text-align: center;
  max-width: 400px;
  width: 100%;
}
.auth-card h1 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}
.auth-card p {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}
.auth-input {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 1rem;
  margin-bottom: 1rem;
  outline: none;
  transition: border-color var(--transition);
}
.auth-input:focus {
  border-color: var(--green-accent);
}
.auth-btn {
  width: 100%;
  padding: 0.75rem;
  background: var(--green-accent);
  color: #000;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition);
}
.auth-btn:hover {
  background: var(--green-hover);
}
.auth-error {
  color: #ef4444;
  margin-top: 1rem;
  font-size: 0.875rem;
}

/* Admin Panel */
.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.admin-header h1 {
  font-size: 1.5rem;
}
.admin-actions-top {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.admin-btn {
  padding: 0.5rem 1rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.admin-btn:hover {
  border-color: var(--border-hover);
  background: var(--bg-elevated);
}
.admin-btn-green {
  background: var(--green-dim);
  border-color: var(--green-accent);
  color: var(--green-accent);
}
.admin-btn-green:hover {
  background: var(--green-accent);
  color: #000;
}
.admin-btn-dim {
  color: var(--text-secondary);
}
.admin-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Status bar */
.admin-status {
  padding: 0.75rem 1rem;
  border-radius: var(--radius-sm);
  margin-bottom: 1.5rem;
  font-size: 0.875rem;
  animation: fadeIn 0.3s;
}
.admin-status.info {
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #93c5fd;
}
.admin-status.success {
  background: var(--green-dim);
  border: 1px solid rgba(52, 211, 153, 0.3);
  color: var(--green-accent);
}
.admin-status.error {
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #fca5a5;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Drafts list */
.drafts-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.loading {
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
}
.admin-empty {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-secondary);
}
.admin-empty h2 {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

/* Draft card */
.draft-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color var(--transition);
}
.draft-card:hover {
  border-color: var(--border-hover);
}
.draft-card-inner {
  display: flex;
  gap: 1.5rem;
  padding: 1.25rem;
}
.draft-image {
  width: 160px;
  height: 100px;
  border-radius: var(--radius-sm);
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg-tertiary);
}
.draft-image-placeholder {
  width: 160px;
  height: 100px;
  border-radius: var(--radius-sm);
  background: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  flex-shrink: 0;
}
.draft-info {
  flex: 1;
  min-width: 0;
}
.draft-title {
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 0.35rem;
  line-height: 1.3;
}
.draft-title a {
  color: var(--text-primary);
  text-decoration: none;
}
.draft-title a:hover {
  color: var(--green-accent);
}
.draft-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}
.draft-summary {
  font-size: 0.875rem;
  color: var(--text-secondary);
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.draft-actions {
  display: flex;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  border-top: 1px solid var(--divider);
  background: rgba(0,0,0,0.2);
}
.draft-actions .admin-btn {
  font-size: 0.8rem;
  padding: 0.4rem 0.75rem;
}
.btn-approve {
  background: var(--green-dim) !important;
  border-color: var(--green-accent) !important;
  color: var(--green-accent) !important;
}
.btn-approve:hover {
  background: var(--green-accent) !important;
  color: #000 !important;
}
.btn-delete {
  color: #ef4444 !important;
  border-color: rgba(239, 68, 68, 0.3) !important;
  background: rgba(239, 68, 68, 0.1) !important;
}
.btn-delete:hover {
  background: #ef4444 !important;
  color: #fff !important;
}
.btn-edit {
  color: #3b82f6 !important;
  border-color: rgba(59, 130, 246, 0.3) !important;
  background: rgba(59, 130, 246, 0.1) !important;
}
.btn-edit:hover {
  background: #3b82f6 !important;
  color: #fff !important;
}
.admin-btn-ai {
  background: rgba(168, 85, 247, 0.15) !important;
  border-color: #a855f7 !important;
  color: #a855f7 !important;
}
.admin-btn-ai:hover {
  background: #a855f7 !important;
  color: #fff !important;
}
.admin-btn-ai:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.admin-btn-img {
  background: rgba(16, 185, 129, 0.15) !important;
  border-color: #10b981 !important;
  color: #10b981 !important;
}
.admin-btn-img:hover {
  background: #10b981 !important;
  color: #fff !important;
}
.admin-btn-img:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-pin {
  background: rgba(234, 179, 8, 0.15) !important;
  border-color: #eab308 !important;
  color: #eab308 !important;
}
.btn-pin:hover {
  background: #eab308 !important;
  color: #000 !important;
}
.btn-unpin {
  background: rgba(234, 179, 8, 0.9) !important;
  border-color: #eab308 !important;
  color: #000 !important;
}
.btn-unpin:hover {
  background: rgba(234, 179, 8, 0.6) !important;
}
.pinned-info {
  font-size: 0.85rem;
  color: #eab308;
  margin-left: 0.5rem;
}

/* All articles section */
.articles-section {
  margin-top: 2rem;
}
.articles-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-bottom: 1rem;
}
.articles-header h2 {
  margin: 0;
  font-size: 1.2rem;
  color: var(--text);
}
.articles-filters {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
#articles-search,
#articles-filter-status,
#articles-filter-cat {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text);
  padding: 6px 10px;
  font-size: 0.85rem;
}
#articles-search {
  width: 200px;
}
#articles-search:focus,
#articles-filter-status:focus,
#articles-filter-cat:focus {
  outline: none;
  border-color: #a855f7;
}
.article-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.6rem 0.75rem;
  border-bottom: 1px solid var(--border);
  transition: background 0.15s;
}
.article-row:hover {
  background: var(--bg-secondary);
}
.article-date {
  color: var(--text-muted);
  font-size: 0.8rem;
  white-space: nowrap;
  min-width: 80px;
}
.article-status {
  font-size: 0.7rem;
  padding: 2px 7px;
  border-radius: 10px;
  white-space: nowrap;
  font-weight: 600;
}
.article-status.published {
  background: rgba(16, 185, 129, 0.15);
  color: #10b981;
}
.article-status.draft {
  background: rgba(234, 179, 8, 0.15);
  color: #eab308;
}
.article-category {
  color: var(--text-muted);
  font-size: 0.8rem;
  min-width: 90px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.article-title {
  flex: 1;
  font-size: 0.9rem;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.article-title a {
  color: var(--text);
  text-decoration: none;
}
.article-title a:hover {
  color: #a855f7;
}
.article-actions {
  display: flex;
  gap: 0.4rem;
  flex-shrink: 0;
}
.article-actions .admin-btn {
  padding: 3px 8px !important;
  font-size: 0.75rem !important;
  min-height: auto !important;
}
.articles-pager {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
  padding: 1rem 0 0.5rem;
}
.articles-pager .admin-btn {
  padding: 4px 10px !important;
  font-size: 0.8rem !important;
  min-height: auto !important;
}
.articles-pager .admin-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}
.articles-page-active {
  background: #a855f7 !important;
  border-color: #a855f7 !important;
  color: #fff !important;
  cursor: default;
}
.articles-page-info {
  color: var(--text-muted);
  font-size: 0.8rem;
  margin-left: 0.5rem;
}
@media (max-width: 768px) {
  .article-row {
    flex-wrap: wrap;
  }
  .article-title {
    width: 100%;
    order: -1;
  }
  #articles-search {
    width: 140px;
  }
}

/* GitHub PAT setup */
.pat-setup {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}
.pat-setup h3 {
  font-size: 1rem;
  margin-bottom: 0.5rem;
}
.pat-setup p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}
.pat-input-row {
  display: flex;
  gap: 0.5rem;
}
.pat-input-row input {
  flex: 1;
  padding: 0.5rem 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  outline: none;
}
.pat-input-row input:focus {
  border-color: var(--green-accent);
}

/* Deploy queue */
.deploy-queue {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 2px solid var(--green-accent);
}
.deploy-queue-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1rem;
}
.deploy-queue-header h2 {
  font-size: 1.15rem;
  color: var(--green-accent);
}
.deploy-queue-actions {
  display: flex;
  gap: 0.5rem;
}
.queue-items {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.queue-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.6rem 1rem;
  background: var(--green-subtle);
  border: 1px solid rgba(52, 211, 153, 0.15);
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
}
.queue-item-title {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--text-primary);
}
.queue-item-cat {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-left: 1rem;
  flex-shrink: 0;
}
.queue-item-remove {
  margin-left: 0.75rem;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.8rem;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  flex-shrink: 0;
}
.queue-item-remove:hover {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

/* Per-article queue items */
.queue-item-per-article {
  flex-direction: column;
  align-items: stretch;
  gap: 0.4rem;
  padding: 0.75rem 1rem;
}
.queue-item-main {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.queue-item-schedule {
  display: flex;
  gap: 0.4rem;
  align-items: center;
}
.schedule-input-sm {
  flex: 1;
  font-size: 0.75rem !important;
  padding: 0.3rem 0.5rem !important;
}
.scheduled-section-title {
  font-size: 0.8rem;
  color: #f59e0b;
  font-weight: 600;
  margin-bottom: 0.4rem;
  padding-top: 0.5rem;
}
.scheduled-item-title-text {
  color: var(--text-secondary);
  font-size: 0.8rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Telegram queue styling */
.tg-queue {
  border-top-color: #0088cc !important;
}
.tg-queue .deploy-queue-header h2 {
  color: #0088cc;
}
.admin-btn-tg {
  background: rgba(0, 136, 204, 0.15) !important;
  border-color: #0088cc !important;
  color: #0088cc !important;
}
.admin-btn-tg:hover {
  background: #0088cc !important;
  color: #fff !important;
}

/* YouTube panel button */
.admin-btn-yt {
  background: rgba(255, 0, 0, 0.12) !important;
  border-color: #c00 !important;
  color: #f44 !important;
}
.admin-btn-yt:hover {
  background: #c00 !important;
  color: #fff !important;
}

/* YouTube panel (full section) */
.yt-panel {
  margin-top: 2rem;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border: 2px solid #c00;
  border-radius: var(--radius-lg);
}
.yt-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.yt-panel-header h2 {
  font-size: 1.15rem;
  color: #f44;
}
.yt-panel-results {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.yt-video-actions {
  display: flex;
  gap: 0.4rem;
  margin-top: 0.4rem;
}
.yt-btn-raw {
  background: var(--green-dim) !important;
  border-color: var(--green-accent) !important;
  color: var(--green-accent) !important;
  font-size: 0.75rem !important;
  padding: 0.3rem 0.6rem !important;
}
.yt-btn-raw:hover {
  background: var(--green-accent) !important;
  color: #000 !important;
}
.yt-btn-ai {
  background: rgba(139, 92, 246, 0.15) !important;
  border-color: #8B5CF6 !important;
  color: #8B5CF6 !important;
  font-size: 0.75rem !important;
  padding: 0.3rem 0.6rem !important;
}
.yt-btn-ai:hover {
  background: #8B5CF6 !important;
  color: #fff !important;
}
.yt-search-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}
.yt-search-input {
  flex: 1;
  padding: 0.6rem 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.9rem;
  outline: none;
}
.yt-search-input:focus {
  border-color: #f44;
}
.yt-search-results {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}
.yt-placeholder {
  text-align: center;
  color: var(--text-secondary);
  padding: 2rem;
}
.yt-result {
  display: flex;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition);
}
.yt-result:hover {
  border-color: #f44;
  background: rgba(255, 0, 0, 0.05);
}
.yt-result-thumb {
  width: 160px;
  height: 90px;
  border-radius: 4px;
  object-fit: cover;
  flex-shrink: 0;
}
.yt-result-info {
  flex: 1;
  min-width: 0;
}
.yt-result-title {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
  color: var(--text-primary);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.yt-result-channel {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.2rem;
}
.yt-result-date {
  font-size: 0.75rem;
  color: var(--text-tertiary);
}

/* Scheduler UI */
.schedule-row {
  display: flex;
  gap: 0.4rem;
  align-items: center;
}
.schedule-input {
  padding: 0.4rem 0.6rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.8rem;
  outline: none;
  transition: border-color var(--transition);
}
.schedule-input:focus {
  border-color: #f59e0b;
}
.admin-btn-schedule {
  background: rgba(245, 158, 11, 0.15) !important;
  border-color: #f59e0b !important;
  color: #f59e0b !important;
  font-size: 0.8rem !important;
  padding: 0.4rem 0.6rem !important;
}
.admin-btn-schedule:hover {
  background: #f59e0b !important;
  color: #000 !important;
}
.scheduled-items {
  margin-top: 0.75rem;
}
.scheduled-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0.75rem;
  background: rgba(245, 158, 11, 0.08);
  border: 1px solid rgba(245, 158, 11, 0.2);
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  margin-bottom: 0.4rem;
}
.scheduled-item-info {
  flex: 1;
  min-width: 0;
  color: #f59e0b;
}
.scheduled-item-time {
  font-weight: 600;
  margin-right: 0.5rem;
}
.scheduled-item-count {
  color: var(--text-secondary);
}
.scheduled-item-cancel {
  margin-left: 0.5rem;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.8rem;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  flex-shrink: 0;
}
.scheduled-item-cancel:hover {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

/* Threads queue styling */
.threads-queue {
  border-top-color: #833AB4 !important;
}
.threads-queue .deploy-queue-header h2 {
  color: #833AB4;
}
.admin-btn-threads {
  background: rgba(131, 58, 180, 0.15) !important;
  border-color: #833AB4 !important;
  color: #833AB4 !important;
}
.admin-btn-threads:hover {
  background: #833AB4 !important;
  color: #fff !important;
}

/* Create article form */
.create-form {
  margin-bottom: 2rem;
}
.create-form-card {
  background: var(--bg-secondary);
  border: 1px solid var(--green-accent);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
}
.create-form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.25rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}
.create-form-header h2 {
  font-size: 1.15rem;
  color: var(--green-accent);
}
.cf-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1rem;
}
.cf-field {
  flex: 1;
  min-width: 200px;
}
.cf-field-wide {
  flex: 1 1 100%;
}
.cf-field label {
  display: block;
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.35rem;
  font-weight: 500;
}
.cf-field input,
.cf-field textarea,
.cf-field select {
  width: 100%;
  padding: 0.55rem 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  outline: none;
  transition: border-color var(--transition);
  font-family: inherit;
}
.cf-field input:focus,
.cf-field textarea:focus,
.cf-field select:focus {
  border-color: var(--green-accent);
}
.cf-field select {
  cursor: pointer;
}
.cf-field select option {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}
.cf-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-top: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}
.cf-submit-btn {
  font-size: 0.95rem !important;
  padding: 0.65rem 1.5rem !important;
}

/* Quill editor overrides for dark theme */
#cf-editor {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  min-height: 250px;
}
.ql-toolbar.ql-snow {
  background: var(--bg-elevated) !important;
  border: none !important;
  border-bottom: 1px solid var(--border) !important;
  border-radius: var(--radius-sm) var(--radius-sm) 0 0 !important;
}
.ql-container.ql-snow {
  border: none !important;
  font-size: 0.95rem;
  font-family: inherit;
  color: var(--text-primary);
}
.ql-editor {
  min-height: 200px;
  color: var(--text-primary) !important;
  line-height: 1.6;
}
.ql-editor.ql-blank::before {
  color: var(--text-tertiary) !important;
  font-style: normal !important;
}
.ql-snow .ql-stroke {
  stroke: var(--text-secondary) !important;
}
.ql-snow .ql-fill,
.ql-snow .ql-stroke.ql-fill {
  fill: var(--text-secondary) !important;
}
.ql-snow .ql-picker-label {
  color: var(--text-secondary) !important;
}
.ql-snow .ql-picker-options {
  background: var(--bg-tertiary) !important;
  border-color: var(--border) !important;
}
.ql-snow .ql-picker-item {
  color: var(--text-primary) !important;
}
.ql-snow .ql-active .ql-stroke {
  stroke: var(--green-accent) !important;
}
.ql-snow .ql-active .ql-fill {
  fill: var(--green-accent) !important;
}
.ql-snow .ql-active {
  color: var(--green-accent) !important;
}
.ql-snow a {
  color: var(--green-accent) !important;
}
.ql-editor blockquote {
  border-left: 3px solid var(--green-accent);
  padding-left: 12px;
  color: var(--text-secondary);
}

/* Responsive */
@media (max-width: 820px) {
  .draft-card-inner {
    flex-direction: column;
    gap: 1rem;
  }
  .draft-image, .draft-image-placeholder {
    width: 100%;
    height: 180px;
  }
  .admin-header {
    flex-direction: column;
    align-items: flex-start;
  }
  .admin-actions-top {
    width: 100%;
  }
  .admin-actions-top .admin-btn {
    flex: 1;
    text-align: center;
  }
  .deploy-queue-actions {
    flex-direction: column;
    width: 100%;
  }
  .schedule-row {
    flex-wrap: wrap;
  }
  .schedule-input {
    flex: 1;
    min-width: 150px;
  }
  .cf-row {
    flex-direction: column;
  }
  .create-form-card {
    padding: 1rem;
  }
}
</style>

<script>
(function() {
  'use strict';

  var ADMIN_KEY_HASH = '{{ .Site.Params.admin_key_hash }}';
  var GITHUB_REPO = '{{ .Site.Params.github_repo }}';
  var SITE_URL = '{{ .Site.BaseURL }}';

  var ghToken = '';
  var adminKey = '';
  var approvedQueue = [];
  var telegramQueue = [];
  var threadsQueue = [];
  var editingFile = null;

  var ALL_ARTICLES = [
    {{ range where .Site.RegularPages "Section" "news" }}
    { title: "{{ .Title | replaceRE `\"` `\\\"` | replaceRE `^\"(.*)\"$` `$1` }}", filename: "{{ .File.LogicalName }}", date: "{{ .Date.Format "2006-01-02" }}", category: "{{ with index .Params.categories 0 }}{{ . }}{{ end }}", image: "{{ .Params.image | default "" }}", draft: {{ if .Draft }}true{{ else }}false{{ end }}, summary: "{{ .Params.summary | default "" | replaceRE `\"` `\\\"` | replaceRE `^\"(.*)\"$` `$1` }}" },
    {{ end }}
  ];

  var PINNED_FILENAME = "{{ with .Site.Data.pinned }}{{ .filename }}{{ end }}";

  var AUTOFORMAT_PROMPT = '–¢–∏ ‚Äî —Ç–∏–ø–æ–≥—Ä–∞—Ñ —Ç–∞ –≤–µ—Ä—Å—Ç–∞–ª—å–Ω–∏–∫ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –Ω–æ–≤–∏–Ω–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞–ª—É KONOPLA.UA.\n\n' +
    '–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è: –æ—Ñ–æ—Ä–º–∏—Ç–∏ –Ω–∞–¥–∞–Ω–∏–π —Ç–µ–∫—Å—Ç —Ç–∏–ø–æ–≥—Ä–∞—Ñ—ñ—á–Ω–æ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ. –ù–ï –∑–º—ñ–Ω—é–π —Å–∞–º —Ç–µ–∫—Å—Ç ‚Äî –ª–∏—à–µ –ø–æ–∫—Ä–∞—â –π–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è.\n\n' +
    '## –©–æ –ú–û–ñ–ù–ê —Ä–æ–±–∏—Ç–∏:\n' +
    '- –†–æ–∑–±–∏—Ç–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –ª–æ–≥—ñ—á–Ω—ñ –∞–±–∑–∞—Ü–∏ (2-4 —Ä–µ—á–µ–Ω–Ω—è –∫–æ–∂–µ–Ω)\n' +
    '- –î–æ–¥–∞—Ç–∏ **–∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç** –¥–ª—è –∫–ª—é—á–æ–≤–∏—Ö —Ñ–∞–∫—Ç—ñ–≤, —Ü–∏—Ñ—Ä, –Ω–∞–∑–≤ –∫–æ–º–ø–∞–Ω—ñ–π\n' +
    '- –î–æ–¥–∞—Ç–∏ > —Ü–∏—Ç–∞—Ç–∏ (blockquote) –¥–ª—è –ø—Ä—è–º–∏—Ö —Ü–∏—Ç–∞—Ç\n' +
    '- –î–æ–¥–∞—Ç–∏ --- (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è) –º—ñ–∂ –≤–µ–ª–∏–∫–∏–º–∏ —Ç–µ–º–∞—Ç–∏—á–Ω–∏–º–∏ –±–ª–æ–∫–∞–º–∏\n' +
    '- –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫ (-) –¥–µ —î –ø–µ—Ä–µ–ª—ñ–∫ 3+ –ø—É–Ω–∫—Ç—ñ–≤\n' +
    '- –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –æ—á–µ–≤–∏–¥–Ω—ñ –¥—Ä—É–∫–∞—Ä—Å—å–∫—ñ –ø–æ–º–∏–ª–∫–∏\n' +
    '- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º—ñ–∂ –∞–±–∑–∞—Ü–∞–º–∏: ![–æ–ø–∏—Å](URL) ‚Äî —è–∫—â–æ —î –≤ –æ—Ä–∏–≥—ñ–Ω–∞–ª—ñ\n\n' +
    '## –©–æ –ù–ï –ú–û–ñ–ù–ê —Ä–æ–±–∏—Ç–∏:\n' +
    '- –ù–ï –ø–µ—Ä–µ–ø–∏—Å—É–π —Ç–µ–∫—Å—Ç —ñ–Ω—à–∏–º–∏ —Å–ª–æ–≤–∞–º–∏\n' +
    '- –ù–ï –¥–æ–¥–∞–≤–∞–π –Ω–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é\n' +
    '- –ù–ï –≤–∏–¥–∞–ª—è–π —Ä–µ—á–µ–Ω–Ω—è —á–∏ —Ñ–∞–∫—Ç–∏\n' +
    '- –ù–ï –∑–º—ñ–Ω—é–π —Å—Ç–∏–ª—å –∞–≤—Ç–æ—Ä–∞\n' +
    '- –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ (## –∞–±–æ ###) –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç–µ–∫—Å—Ç—É\n\n' +
    '## –î–æ–¥–∞—Ç–∫–æ–≤–æ:\n' +
    '- –ó–≥–µ–Ω–µ—Ä—É–π title (–¥–æ 80 —Å–∏–º–≤–æ–ª—ñ–≤) —Ç–∞ summary (1-2 —Ä–µ—á–µ–Ω–Ω—è) –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–µ–∫—Å—Ç—É\n' +
    '- –í–∏–∑–Ω–∞—á category —Ç–∞ tags\n\n' +
    '## –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó: —Ç–µ–∫—Å—Ç–∏–ª—å, –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ, –∞–≥—Ä–æ, –±—ñ–æ–ø–ª–∞—Å—Ç–∏–∫, –∞–≤—Ç–æ–ø—Ä–æ–º, —Ö–∞—Ä—á–æ–≤–∞, –µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞, –∫–æ—Å–º–µ—Ç–∏–∫–∞, –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ, –Ω–∞—É–∫–∞, –µ–∫–æ–ª–æ–≥—ñ—è, –±—ñ–∑–Ω–µ—Å, –≤—ñ–¥–µ–æ, —ñ–Ω—à–µ\n\n' +
    '## –§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚Äî –°–¢–†–û–ì–û JSON:\n' +
    '{"title":"–ó–∞–≥–æ–ª–æ–≤–æ–∫","summary":"–ê–Ω–æ–Ω—Å","content":"–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–π —Ç–µ–∫—Å—Ç –∑ \\n\\n –º—ñ–∂ –∞–±–∑–∞—Ü–∞–º–∏","category":"–∫–∞—Ç–µ–≥–æ—Ä—ñ—è","tags":["—Ç–µ–≥1","—Ç–µ–≥2","—Ç–µ–≥3"]}';

  // =========================================================================
  // Auth
  // =========================================================================

  function init() {
    // Check URL param
    var params = new URLSearchParams(window.location.search);
    var key = params.get('key');
    if (key) {
      checkAuth(key);
      return;
    }

    // Check localStorage
    var saved = localStorage.getItem('konopla_admin_key');
    if (saved) {
      checkAuth(saved);
      return;
    }

    showAuth();
  }

  function showAuth() {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('admin-panel').style.display = 'none';
  }

  function showPanel() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';

    // Load GitHub PAT from localStorage
    ghToken = localStorage.getItem('konopla_gh_token') || '';

    // Load queues from localStorage
    loadQueue();
    renderQueue();
    loadTgQueue();
    renderTgQueue();
    loadThreadsQueue();
    renderThreadsQueue();

    // Load scheduled items (async, non-blocking)
    if (ghToken) {
      loadScheduledItems();
    }

    if (!ghToken) {
      showPatSetup();
    } else {
      loadDrafts();
    }
    renderArticles();
  }

  async function checkAuth(key) {
    var hash = await sha256(key);
    if (hash === ADMIN_KEY_HASH) {
      adminKey = key;
      localStorage.setItem('konopla_admin_key', key);
      // Clean URL
      if (window.location.search) {
        window.history.replaceState({}, '', window.location.pathname);
      }
      showPanel();
    } else {
      localStorage.removeItem('konopla_admin_key');
      showAuth();
      document.getElementById('auth-error').style.display = 'block';
    }
  }

  function logout() {
    localStorage.removeItem('konopla_admin_key');
    localStorage.removeItem('konopla_gh_token');
    adminKey = '';
    ghToken = '';
    showAuth();
  }

  async function sha256(str) {
    var buf = new TextEncoder().encode(str);
    var hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
  }

  // Auth form handler
  document.getElementById('auth-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var key = document.getElementById('auth-key').value.trim();
    if (key) checkAuth(key);
  });

  // =========================================================================
  // GitHub PAT setup
  // =========================================================================

  function showPatSetup() {
    var el = document.getElementById('drafts-list');
    el.innerHTML = '<div class="pat-setup">' +
      '<h3>üîë GitHub Token</h3>' +
      '<p>–î–ª—è –º–æ–¥–µ—Ä–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–µ–Ω GitHub Personal Access Token (fine-grained) –∑ –ø—Ä–∞–≤–∞–º–∏ <code>contents:write</code> —Ç–∞ <code>actions:write</code> –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é <code>' + GITHUB_REPO + '</code>.</p>' +
      '<div class="pat-input-row">' +
        '<input type="password" id="pat-input" placeholder="github_pat_...">' +
        '<button class="admin-btn admin-btn-green" onclick="saveToken()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>' +
      '</div>' +
    '</div>';
  }

  window.saveToken = function() {
    var token = document.getElementById('pat-input').value.trim();
    if (!token) return;
    ghToken = token;
    localStorage.setItem('konopla_gh_token', token);
    showStatus('Token –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
    loadDrafts();
  };

  // =========================================================================
  // Load drafts
  // =========================================================================

  window.loadDrafts = async function() {
    if (!ghToken) {
      showPatSetup();
      return;
    }

    var el = document.getElementById('drafts-list');
    el.innerHTML = '<div class="loading">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
    document.getElementById('empty-state').style.display = 'none';

    try {
      // Fetch drafts.json from repo
      var resp = await ghApi('GET', '/contents/data/drafts.json');

      if (resp.status === 404) {
        el.innerHTML = '';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      if (!resp.ok) throw new Error('GitHub API error: ' + resp.status);

      var data = await resp.json();
      var content = JSON.parse(b64DecodeUtf8(data.content));
      var articles = (content.articles || []).filter(function(a) { return a && a.filename; });

      if (articles.length === 0) {
        el.innerHTML = '';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      // Sort newest first
      articles.sort(function(a, b) {
        return (b.created_at || '').localeCompare(a.created_at || '');
      });

      el.innerHTML = articles.map(function(a) {
        var img = a.image
          ? '<img src="' + escHtml(a.image) + '" alt="" class="draft-image">'
          : '<div class="draft-image-placeholder">üì∞</div>';

        var cat = a.category || '';
        var date = a.created_at ? new Date(a.created_at).toLocaleString('uk-UA') : '';

        return '<div class="draft-card" data-filename="' + escHtml(a.filename) + '" data-id="' + escHtml(a.id) + '">' +
          '<div class="draft-card-inner">' +
            img +
            '<div class="draft-info">' +
              '<h3 class="draft-title"><a href="/news/' + escHtml(a.filename.replace('.md', '')) + '/" target="_blank">' + escHtml(a.title) + '</a></h3>' +
              '<div class="draft-meta"><span>' + escHtml(cat) + '</span><span>' + escHtml(date) + '</span></div>' +
              '<p class="draft-summary">' + escHtml(a.summary || '') + '</p>' +
            '</div>' +
          '</div>' +
          '<div class="draft-actions">' +
            '<button class="admin-btn btn-approve" onclick="approveArticle(\'' + escHtml(a.filename) + '\', \'' + escHtml(a.id) + '\')">‚úÖ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>' +
            '<button class="admin-btn btn-edit" onclick="editArticle(\'' + escHtml(a.filename) + '\')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>' +
            '<button class="admin-btn btn-delete" onclick="deleteArticle(\'' + escHtml(a.filename) + '\', \'' + escHtml(a.id) + '\')">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏</button>' +
            '<a href="/news/' + escHtml(a.filename.replace('.md', '')) + '/" target="_blank" class="admin-btn">üëÅ Preview</a>' +
          '</div>' +
        '</div>';
      }).join('');

    } catch (e) {
      console.error('Load error:', e);
      el.innerHTML = '<div class="loading">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + escHtml(e.message) + '</div>';

      if (e.message && e.message.indexOf('401') !== -1) {
        localStorage.removeItem('konopla_gh_token');
        ghToken = '';
        showPatSetup();
      }
    }
  };

  // =========================================================================
  // Approve article: change draft:true ‚Üí draft:false
  // =========================================================================

  window.approveArticle = async function(filename, articleId) {
    if (!confirm('–°—Ö–≤–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é?')) return;

    var card = document.querySelector('[data-filename="' + filename + '"]');
    // Get title from card before disabling
    var titleEl = card ? card.querySelector('.draft-title a') : null;
    var title = titleEl ? titleEl.textContent : filename;
    var catEl = card ? card.querySelector('.draft-meta span') : null;
    var category = catEl ? catEl.textContent : '';

    disableCard(card);
    showStatus('‚è≥ –°—Ö–≤–∞–ª—é—î–º–æ...', 'info');

    try {
      // 1. Get the .md file
      var fileResp = await ghApi('GET', '/contents/content/news/' + filename);
      if (!fileResp.ok) throw new Error('Cannot fetch file: ' + fileResp.status);
      var fileData = await fileResp.json();

      // 2. Decode content, replace draft: true ‚Üí draft: false
      var decoded = b64DecodeUtf8(fileData.content);
      var updated = decoded.replace(/^draft:\s*true$/m, 'draft: false');

      if (updated === decoded) {
        showStatus('‚ö†Ô∏è –§–∞–π–ª –≤–∂–µ –Ω–µ draft –∞–±–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ draft: true', 'error');
        enableCard(card);
        return;
      }

      // 3. PUT updated file back
      var putResp = await ghApi('PUT', '/contents/content/news/' + filename, {
        message: '‚úÖ Approve: ' + filename,
        content: b64EncodeUtf8(updated),
        sha: fileData.sha
      });

      if (!putResp.ok) {
        var err = await putResp.json().catch(function() { return {}; });
        throw new Error('PUT failed: ' + (err.message || putResp.status));
      }

      // 4. Remove from drafts.json
      await removeDraftEntry(articleId);

      // 5. Add to deploy queue AND telegram queue
      var queueItem = {
        title: title,
        filename: filename,
        category: category,
        approvedAt: new Date().toISOString()
      };
      approvedQueue.push(queueItem);
      saveQueue();
      renderQueue();

      telegramQueue.push(queueItem);
      saveTgQueue();
      renderTgQueue();

      threadsQueue.push(queueItem);
      saveThreadsQueue();
      renderThreadsQueue();

      showStatus('‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ! –î–æ–¥–∞–Ω–æ –≤ —á–µ—Ä–≥–∏ –¥–µ–ø–ª–æ–π + Telegram + Threads.', 'success');

      // Remove card from UI
      if (card) card.remove();

      // Check if list is empty
      var remaining = document.querySelectorAll('.draft-card');
      if (remaining.length === 0) {
        document.getElementById('empty-state').style.display = 'block';
      }

    } catch (e) {
      console.error('Approve error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
      enableCard(card);
    }
  };

  // =========================================================================
  // Delete article
  // =========================================================================

  window.deleteArticle = async function(filename, articleId) {
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;

    var card = document.querySelector('[data-filename="' + filename + '"]');
    disableCard(card);
    showStatus('‚è≥ –í–∏–¥–∞–ª—è—î–º–æ...', 'info');

    try {
      // 1. Get file SHA
      var fileResp = await ghApi('GET', '/contents/content/news/' + filename);
      if (!fileResp.ok && fileResp.status !== 404) throw new Error('Cannot fetch file: ' + fileResp.status);

      if (fileResp.ok) {
        var fileData = await fileResp.json();

        // 2. Delete file
        var delResp = await ghApi('DELETE', '/contents/content/news/' + filename, {
          message: '‚ùå Delete: ' + filename,
          sha: fileData.sha
        });

        if (!delResp.ok) {
          var err = await delResp.json().catch(function() { return {}; });
          throw new Error('DELETE failed: ' + (err.message || delResp.status));
        }
      }

      // 3. Remove from drafts.json
      await removeDraftEntry(articleId);

      showStatus('üóëÔ∏è –°—Ç–∞—Ç—Ç—è –≤–∏–¥–∞–ª–µ–Ω–∞.', 'success');

      if (card) card.remove();

      var remaining = document.querySelectorAll('.draft-card');
      if (remaining.length === 0) {
        document.getElementById('empty-state').style.display = 'block';
      }

    } catch (e) {
      console.error('Delete error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
      enableCard(card);
    }
  };

  // =========================================================================
  // Run pipeline
  // =========================================================================

  window.runPipeline = async function() {
    if (!ghToken) {
      showStatus('‚ùå –ü–æ—Ç—Ä—ñ–±–µ–Ω GitHub Token', 'error');
      return;
    }

    showStatus('‚è≥ –ó–∞–ø—É—Å–∫ –∑–±–æ—Ä—É –Ω–æ–≤–∏–Ω (—Å–≤—ñ—Ç + UA)...', 'info');
    document.getElementById('btn-run-pipeline').disabled = true;

    var results = [];
    try {
      // Trigger pipelines sequentially to avoid race on data/drafts.json
      var resp1 = await ghApi('POST', '/actions/workflows/pipeline.yml/dispatches', { ref: 'main' });
      if (resp1.status === 204 || resp1.ok) results.push('üåç –°–≤—ñ—Ç');
      else results.push('‚ùå –°–≤—ñ—Ç: ' + resp1.status);

      var resp2 = await ghApi('POST', '/actions/workflows/ua_pipeline.yml/dispatches', { ref: 'main' });
      if (resp2.status === 204 || resp2.ok) results.push('üá∫üá¶ UA');
      else results.push('‚ùå UA: ' + resp2.status);

      showStatus('üöÄ –ó–±—ñ—Ä –∑–∞–ø—É—â–µ–Ω–æ: ' + results.join(', ') + '. –ù–æ–≤—ñ —Å—Ç–∞—Ç—Ç—ñ –∑\'—è–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É: ' + e.message, 'error');
    }

    setTimeout(function() {
      document.getElementById('btn-run-pipeline').disabled = false;
    }, 10000);
  };

  // =========================================================================
  // Helpers
  // =========================================================================

  async function removeDraftEntry(articleId) {
    try {
      var resp = await ghApi('GET', '/contents/data/drafts.json');
      if (!resp.ok) return;

      var data = await resp.json();
      var content = JSON.parse(b64DecodeUtf8(data.content));

      content.articles = (content.articles || []).filter(function(a) {
        return a.id !== articleId;
      });

      var encoded = b64EncodeUtf8(JSON.stringify(content, null, 2));

      await ghApi('PUT', '/contents/data/drafts.json', {
        message: 'üìã Update drafts.json',
        content: encoded,
        sha: data.sha
      });
    } catch (e) {
      console.warn('Failed to update drafts.json:', e);
    }
  }

  // =========================================================================
  // Deploy queue
  // =========================================================================

  function loadQueue() {
    try {
      var saved = localStorage.getItem('konopla_deploy_queue');
      approvedQueue = saved ? JSON.parse(saved) : [];
    } catch (e) {
      approvedQueue = [];
    }
  }

  function saveQueue() {
    localStorage.setItem('konopla_deploy_queue', JSON.stringify(approvedQueue));
  }

  function renderQueue() {
    var container = document.getElementById('deploy-queue');
    var itemsEl = document.getElementById('queue-items');
    var countEl = document.getElementById('queue-count');

    if (!approvedQueue.length) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    countEl.textContent = approvedQueue.length;

    itemsEl.innerHTML = approvedQueue.map(function(item, idx) {
      return '<div class="queue-item queue-item-per-article">' +
        '<div class="queue-item-main">' +
          '<span class="queue-item-title">' + escHtml(item.title) + '</span>' +
          '<span class="queue-item-cat">' + escHtml(item.category || '') + '</span>' +
          '<button class="queue-item-remove" onclick="removeFromQueue(' + idx + ')" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úï</button>' +
        '</div>' +
        '<div class="queue-item-schedule">' +
          '<input type="datetime-local" class="schedule-input schedule-input-sm" id="sched-deploy-' + idx + '">' +
          '<button class="admin-btn admin-btn-schedule" onclick="scheduleArticle(\'deploy\',' + idx + ')">‚è∞</button>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  window.removeFromQueue = function(idx) {
    approvedQueue.splice(idx, 1);
    saveQueue();
    renderQueue();
  };

  window.clearQueue = function() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ —á–µ—Ä–≥—É? (–°—Ç–∞—Ç—Ç—ñ –≤–∂–µ —Å—Ö–≤–∞–ª–µ–Ω—ñ, –∞–ª–µ –¥–µ–ø–ª–æ–π –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è)')) return;
    approvedQueue = [];
    saveQueue();
    renderQueue();
  };

  window.deployAll = async function() {
    if (!approvedQueue.length) return;
    if (!confirm('–ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ ' + approvedQueue.length + ' —Å—Ç–∞—Ç–µ–π?')) return;

    showStatus('‚è≥ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—é...', 'info');

    try {
      await triggerDeploy();
      var count = approvedQueue.length;
      approvedQueue = [];
      saveQueue();
      renderQueue();
      showStatus('üöÄ –î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω–æ! ' + count + ' —Å—Ç–∞—Ç–µ–π –∑\'—è–≤–ª—è—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç—ñ –∑–∞ 1-2 —Ö–≤.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–µ–ø–ª–æ—é: ' + e.message, 'error');
    }
  };

  async function triggerDeploy() {
    try {
      await ghApi('POST', '/actions/workflows/moderate.yml/dispatches', {
        ref: 'main'
      });
    } catch (e) {
      console.warn('Failed to trigger deploy:', e);
    }
  }

  // =========================================================================
  // Telegram queue
  // =========================================================================

  function loadTgQueue() {
    try {
      var saved = localStorage.getItem('konopla_tg_queue');
      telegramQueue = saved ? JSON.parse(saved) : [];
    } catch (e) {
      telegramQueue = [];
    }
  }

  function saveTgQueue() {
    localStorage.setItem('konopla_tg_queue', JSON.stringify(telegramQueue));
  }

  function renderTgQueue() {
    var container = document.getElementById('tg-queue');
    var itemsEl = document.getElementById('tg-queue-items');
    var countEl = document.getElementById('tg-queue-count');

    if (!telegramQueue.length) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    countEl.textContent = telegramQueue.length;

    itemsEl.innerHTML = telegramQueue.map(function(item, idx) {
      return '<div class="queue-item queue-item-per-article">' +
        '<div class="queue-item-main">' +
          '<span class="queue-item-title">' + escHtml(item.title) + '</span>' +
          '<span class="queue-item-cat">' + escHtml(item.category || '') + '</span>' +
          '<button class="queue-item-remove" onclick="removeFromTgQueue(' + idx + ')" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úï</button>' +
        '</div>' +
        '<div class="queue-item-schedule">' +
          '<input type="datetime-local" class="schedule-input schedule-input-sm" id="sched-telegram-' + idx + '">' +
          '<button class="admin-btn admin-btn-schedule" onclick="scheduleArticle(\'telegram\',' + idx + ')">‚è∞</button>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  window.removeFromTgQueue = function(idx) {
    telegramQueue.splice(idx, 1);
    saveTgQueue();
    renderTgQueue();
  };

  window.clearTgQueue = function() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ Telegram —á–µ—Ä–≥—É?')) return;
    telegramQueue = [];
    saveTgQueue();
    renderTgQueue();
  };

  window.postToTelegram = async function() {
    if (!telegramQueue.length) return;
    if (!confirm('–ü–æ—Å—Ç–∏—Ç–∏ ' + telegramQueue.length + ' —Å—Ç–∞—Ç–µ–π –≤ Telegram?')) return;

    showStatus('‚è≥ –ì–æ—Ç—É—î–º–æ Telegram –ø–æ—Å—Ç–∏–Ω–≥...', 'info');

    try {
      // 1. Write telegram_queue.json to repo
      var queueData = {
        articles: telegramQueue.map(function(item) {
          return { filename: item.filename, title: item.title, category: item.category };
        })
      };

      // Get current file to get SHA (or handle 404 for new file)
      var getResp = await ghApi('GET', '/contents/data/telegram_queue.json');
      var sha = null;
      if (getResp.ok) {
        var existing = await getResp.json();
        sha = existing.sha;
      }

      var putBody = {
        message: 'üì® Telegram queue: ' + telegramQueue.length + ' articles',
        content: b64EncodeUtf8(JSON.stringify(queueData, null, 2))
      };
      if (sha) putBody.sha = sha;

      var putResp = await ghApi('PUT', '/contents/data/telegram_queue.json', putBody);
      if (!putResp.ok) throw new Error('Failed to write queue: ' + putResp.status);

      // 2. Wait for GitHub to process the commit before triggering workflow
      showStatus('‚è≥ –ß–µ–∫–∞—î–º–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é GitHub...', 'info');
      await new Promise(function(r) { setTimeout(r, 5000); });

      // 3. Trigger telegram_post.yml workflow
      await ghApi('POST', '/actions/workflows/telegram_post.yml/dispatches', {
        ref: 'main'
      });

      var count = telegramQueue.length;
      telegramQueue = [];
      saveTgQueue();
      renderTgQueue();
      showStatus('üì® Telegram –ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω–æ! ' + count + ' —Å—Ç–∞—Ç–µ–π.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  // =========================================================================
  // Threads queue
  // =========================================================================

  function loadThreadsQueue() {
    try {
      var saved = localStorage.getItem('konopla_threads_queue');
      threadsQueue = saved ? JSON.parse(saved) : [];
    } catch (e) {
      threadsQueue = [];
    }
  }

  function saveThreadsQueue() {
    localStorage.setItem('konopla_threads_queue', JSON.stringify(threadsQueue));
  }

  function renderThreadsQueue() {
    var container = document.getElementById('threads-queue');
    var itemsEl = document.getElementById('threads-queue-items');
    var countEl = document.getElementById('threads-queue-count');

    if (!threadsQueue.length) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    countEl.textContent = threadsQueue.length;

    itemsEl.innerHTML = threadsQueue.map(function(item, idx) {
      return '<div class="queue-item queue-item-per-article">' +
        '<div class="queue-item-main">' +
          '<span class="queue-item-title">' + escHtml(item.title) + '</span>' +
          '<span class="queue-item-cat">' + escHtml(item.category || '') + '</span>' +
          '<button class="queue-item-remove" onclick="removeFromThreadsQueue(' + idx + ')" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úï</button>' +
        '</div>' +
        '<div class="queue-item-schedule">' +
          '<input type="datetime-local" class="schedule-input schedule-input-sm" id="sched-threads-' + idx + '">' +
          '<button class="admin-btn admin-btn-schedule" onclick="scheduleArticle(\'threads\',' + idx + ')">‚è∞</button>' +
        '</div>' +
      '</div>';
    }).join('');
  }

  window.removeFromThreadsQueue = function(idx) {
    threadsQueue.splice(idx, 1);
    saveThreadsQueue();
    renderThreadsQueue();
  };

  window.clearThreadsQueue = function() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ Threads —á–µ—Ä–≥—É?')) return;
    threadsQueue = [];
    saveThreadsQueue();
    renderThreadsQueue();
  };

  window.postToThreads = async function() {
    if (!threadsQueue.length) return;
    if (!confirm('–ü–æ—Å—Ç–∏—Ç–∏ ' + threadsQueue.length + ' —Å—Ç–∞—Ç–µ–π –≤ Threads?')) return;

    showStatus('‚è≥ –ì–æ—Ç—É—î–º–æ Threads –ø–æ—Å—Ç–∏–Ω–≥...', 'info');

    try {
      // 1. Write threads_queue.json to repo
      var queueData = {
        articles: threadsQueue.map(function(item) {
          return { filename: item.filename, title: item.title, category: item.category };
        })
      };

      // Get current file to get SHA (or handle 404 for new file)
      var getResp = await ghApi('GET', '/contents/data/threads_queue.json');
      var sha = null;
      if (getResp.ok) {
        var existing = await getResp.json();
        sha = existing.sha;
      }

      var putBody = {
        message: 'üßµ Threads queue: ' + threadsQueue.length + ' articles',
        content: b64EncodeUtf8(JSON.stringify(queueData, null, 2))
      };
      if (sha) putBody.sha = sha;

      var putResp = await ghApi('PUT', '/contents/data/threads_queue.json', putBody);
      if (!putResp.ok) throw new Error('Failed to write queue: ' + putResp.status);

      // 2. Wait for GitHub to process the commit before triggering workflow
      showStatus('‚è≥ –ß–µ–∫–∞—î–º–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é GitHub...', 'info');
      await new Promise(function(r) { setTimeout(r, 5000); });

      // 3. Trigger threads_post.yml workflow
      await ghApi('POST', '/actions/workflows/threads_post.yml/dispatches', {
        ref: 'main'
      });

      var count = threadsQueue.length;
      threadsQueue = [];
      saveThreadsQueue();
      renderThreadsQueue();
      showStatus('üßµ Threads –ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω–æ! ' + count + ' —Å—Ç–∞—Ç–µ–π.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  // =========================================================================
  // Scheduler
  // =========================================================================

  // Per-article scheduling: schedule one article from a queue
  window.scheduleArticle = async function(type, idx) {
    var inputId = 'sched-' + type + '-' + idx;
    var input = document.getElementById(inputId);
    if (!input || !input.value) {
      showStatus('‚ùå –û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É —Ç–∞ —á–∞—Å –¥–ª—è —Ü—ñ—î—ó —Å—Ç–∞—Ç—Ç—ñ', 'error');
      return;
    }

    // Get the queue and article
    var queue;
    if (type === 'deploy') queue = approvedQueue;
    else if (type === 'telegram') queue = telegramQueue;
    else if (type === 'threads') queue = threadsQueue;

    if (!queue || !queue[idx]) {
      showStatus('‚ùå –°—Ç–∞—Ç—Ç—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –≤ —á–µ—Ä–∑—ñ', 'error');
      return;
    }

    var article = queue[idx];
    var localDate = new Date(input.value);
    var scheduledAt = localDate.toISOString();

    if (localDate <= new Date()) {
      showStatus('‚ùå –ß–∞—Å –º–∞—î –±—É—Ç–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É', 'error');
      return;
    }

    var typeLabels = { deploy: '–¥–µ–ø–ª–æ–π', telegram: 'Telegram', threads: 'Threads' };
    if (!confirm('–ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ "' + article.title + '" (' + typeLabels[type] + ') –Ω–∞ ' + localDate.toLocaleString('uk-UA') + '?')) return;

    showStatus('‚è≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–æ–∑–∫–ª–∞–¥...', 'info');

    try {
      // Read current scheduled.json from repo
      var getResp = await ghApi('GET', '/contents/data/scheduled.json');
      var sha = null;
      var scheduled = { deploy: [], telegram: [], threads: [] };

      if (getResp.ok) {
        var fileData = await getResp.json();
        sha = fileData.sha;
        scheduled = JSON.parse(b64DecodeUtf8(fileData.content));
      }

      // Create per-article scheduled item
      var schedItem = {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        filename: article.filename,
        title: article.title,
        category: article.category || '',
        scheduled_at: scheduledAt,
        created_at: new Date().toISOString()
      };

      if (!scheduled[type]) scheduled[type] = [];
      scheduled[type].push(schedItem);

      // Write back to repo
      var putBody = {
        message: '‚è∞ Schedule ' + type + ': ' + article.title.slice(0, 40),
        content: b64EncodeUtf8(JSON.stringify(scheduled, null, 2))
      };
      if (sha) putBody.sha = sha;

      var putResp = await ghApi('PUT', '/contents/data/scheduled.json', putBody);
      if (!putResp.ok) throw new Error('Failed to save schedule: ' + putResp.status);

      // Remove article from local queue
      queue.splice(idx, 1);
      if (type === 'deploy') { saveQueue(); renderQueue(); }
      else if (type === 'telegram') { saveTgQueue(); renderTgQueue(); }
      else if (type === 'threads') { saveThreadsQueue(); renderThreadsQueue(); }

      // Reload scheduled items display
      loadScheduledItems();

      showStatus('‚è∞ "' + article.title + '" –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ –Ω–∞ ' + localDate.toLocaleString('uk-UA') + '!', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è: ' + e.message, 'error');
    }
  };

  window.cancelScheduled = async function(type, itemId) {
    if (!confirm('–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—É –¥—ñ—é?')) return;

    showStatus('‚è≥ –°–∫–∞—Å–æ–≤—É—î–º–æ...', 'info');

    try {
      var getResp = await ghApi('GET', '/contents/data/scheduled.json');
      if (!getResp.ok) throw new Error('Cannot read scheduled.json');

      var fileData = await getResp.json();
      var scheduled = JSON.parse(b64DecodeUtf8(fileData.content));

      if (scheduled[type]) {
        scheduled[type] = scheduled[type].filter(function(item) { return item.id !== itemId; });
      }

      var putBody = {
        message: '‚è∞ Cancel scheduled ' + type,
        content: b64EncodeUtf8(JSON.stringify(scheduled, null, 2)),
        sha: fileData.sha
      };

      var putResp = await ghApi('PUT', '/contents/data/scheduled.json', putBody);
      if (!putResp.ok) throw new Error('Failed to update schedule: ' + putResp.status);

      loadScheduledItems();
      showStatus('‚úÖ –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—É –¥—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  async function loadScheduledItems() {
    try {
      var getResp = await ghApi('GET', '/contents/data/scheduled.json');
      if (!getResp.ok) return;

      var fileData = await getResp.json();
      var scheduled = JSON.parse(b64DecodeUtf8(fileData.content));

      renderScheduledSection('deploy', scheduled.deploy || []);
      renderScheduledSection('telegram', scheduled.telegram || []);
      renderScheduledSection('threads', scheduled.threads || []);
    } catch (e) {
      console.warn('Failed to load scheduled items:', e);
    }
  }

  function renderScheduledSection(type, items) {
    var container = document.getElementById('scheduled-' + type);
    if (!container) return;

    if (!items.length) {
      container.innerHTML = '';
      // Show the parent queue section if there are scheduled items even when queue is empty
      return;
    }

    // Make parent queue visible if it has scheduled items
    var parentId = type === 'deploy' ? 'deploy-queue' : (type === 'telegram' ? 'tg-queue' : 'threads-queue');
    var parentEl = document.getElementById(parentId);
    if (parentEl) parentEl.style.display = 'block';

    var typeEmoji = { deploy: 'üöÄ', telegram: 'üì®', threads: 'üßµ' };

    container.innerHTML = '<div class="scheduled-section-title">‚è∞ –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ:</div>' +
      items.map(function(item) {
        var dt = new Date(item.scheduled_at);

        // Per-article format: item has filename directly
        if (item.filename) {
          return '<div class="scheduled-item">' +
            '<div class="scheduled-item-info">' +
              '<span class="scheduled-item-time">' + typeEmoji[type] + ' ' + dt.toLocaleString('uk-UA') + '</span>' +
              '<span class="scheduled-item-title-text">' + escHtml(item.title || item.filename) + '</span>' +
            '</div>' +
            '<button class="scheduled-item-cancel" onclick="cancelScheduled(\'' + type + '\', \'' + escHtml(item.id) + '\')" title="–°–∫–∞—Å—É–≤–∞—Ç–∏">‚úï</button>' +
          '</div>';
        }

        // Legacy batch format: item has articles array
        var articlesCount = (item.articles || []).length;
        var titles = (item.articles || []).map(function(a) { return a.title; }).join(', ');

        return '<div class="scheduled-item">' +
          '<div class="scheduled-item-info">' +
            '<span class="scheduled-item-time">' + typeEmoji[type] + ' ' + dt.toLocaleString('uk-UA') + '</span>' +
            '<span class="scheduled-item-count">' + articlesCount + ' —Å—Ç–∞—Ç.' + (titles ? ' ‚Äî ' + escHtml(titles).slice(0, 60) : '') + '</span>' +
          '</div>' +
          '<button class="scheduled-item-cancel" onclick="cancelScheduled(\'' + type + '\', \'' + escHtml(item.id) + '\')" title="–°–∫–∞—Å—É–≤–∞—Ç–∏">‚úï</button>' +
        '</div>';
      }).join('');
  }

  // =========================================================================
  // YouTube Panel
  // =========================================================================

  window.toggleYtPanel = function() {
    var panel = document.getElementById('yt-panel');
    var visible = panel.style.display !== 'none';
    panel.style.display = visible ? 'none' : 'block';
    if (!visible) {
      // Check for YouTube API key
      var ytKey = localStorage.getItem('konopla_yt_key');
      if (!ytKey) {
        ytKey = prompt('–í–≤–µ–¥—ñ—Ç—å YouTube Data API Key (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ):');
        if (!ytKey) { panel.style.display = 'none'; return; }
        localStorage.setItem('konopla_yt_key', ytKey);
      }
      document.getElementById('yt-search-input').focus();
    }
  };

  window.ytPanelSearch = async function() {
    var query = document.getElementById('yt-search-input').value.trim();
    if (!query) return;

    var ytKey = localStorage.getItem('konopla_yt_key');
    if (!ytKey) {
      ytKey = prompt('–í–≤–µ–¥—ñ—Ç—å YouTube Data API Key:');
      if (!ytKey) return;
      localStorage.setItem('konopla_yt_key', ytKey);
    }

    var resultsEl = document.getElementById('yt-panel-results');
    resultsEl.innerHTML = '<p class="yt-placeholder">‚è≥ –ü–æ—à—É–∫...</p>';

    try {
      var url = 'https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&order=date&maxResults=10&relevanceLanguage=uk&q=' + encodeURIComponent(query) + '&key=' + encodeURIComponent(ytKey);

      var resp = await fetch(url);
      if (!resp.ok) {
        if (resp.status === 403 || resp.status === 400) {
          localStorage.removeItem('konopla_yt_key');
          throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π API –∫–ª—é—á. –°–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É.');
        }
        throw new Error('YouTube API error: ' + resp.status);
      }

      var data = await resp.json();
      var videos = data.items || [];

      if (!videos.length) {
        resultsEl.innerHTML = '<p class="yt-placeholder">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
      }

      resultsEl.innerHTML = videos.map(function(item) {
        var vid = item.id.videoId;
        var snippet = item.snippet;
        var thumb = snippet.thumbnails.medium ? snippet.thumbnails.medium.url : '';
        var title = snippet.title;
        var channel = snippet.channelTitle;
        var published = new Date(snippet.publishedAt).toLocaleDateString('uk-UA');

        return '<div class="yt-result">' +
          '<img class="yt-result-thumb" src="' + escHtml(thumb) + '" alt="">' +
          '<div class="yt-result-info">' +
            '<div class="yt-result-title">' + escHtml(title) + '</div>' +
            '<div class="yt-result-channel">' + escHtml(channel) + '</div>' +
            '<div class="yt-result-date">' + escHtml(published) + '</div>' +
            '<div class="yt-video-actions">' +
              '<button class="admin-btn yt-btn-raw" onclick="addYtVideo(\'' + escHtml(vid) + '\', \'raw\')">üìã –Ø–∫ —î</button>' +
              '<button class="admin-btn yt-btn-ai" onclick="addYtVideo(\'' + escHtml(vid) + '\', \'ai\')">ü§ñ AI —Å—Ç–∞—Ç—Ç—è</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');

    } catch (e) {
      resultsEl.innerHTML = '<p class="yt-placeholder">‚ùå ' + escHtml(e.message) + '</p>';
    }
  };

  // Handle Enter key in YouTube search input
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.activeElement && document.activeElement.id === 'yt-search-input') {
      e.preventDefault();
      ytPanelSearch();
    }
  });

  window.addYtVideo = async function(videoId, mode) {
    if (mode === 'raw') {
      // Open create form, fill in YouTube ID and set category
      document.getElementById('create-form').style.display = 'block';
      initQuill();
      document.getElementById('cf-youtube').value = videoId;
      document.getElementById('cf-category').value = '–≤—ñ–¥–µ–æ';

      // Fetch video details to auto-fill title/summary
      try {
        var ytKey = localStorage.getItem('konopla_yt_key');
        if (ytKey) {
          var detResp = await fetch('https://www.googleapis.com/youtube/v3/videos?part=snippet&id=' + videoId + '&key=' + encodeURIComponent(ytKey));
          if (detResp.ok) {
            var detData = await detResp.json();
            if (detData.items && detData.items.length > 0) {
              var snippet = detData.items[0].snippet;
              var titleInput = document.getElementById('cf-title');
              if (!titleInput.value.trim()) titleInput.value = snippet.title || '';
              var summaryInput = document.getElementById('cf-summary');
              if (!summaryInput.value.trim()) summaryInput.value = (snippet.description || '').slice(0, 280);
              document.getElementById('cf-image').value = snippet.thumbnails.high ? snippet.thumbnails.high.url : '';
            }
          }
        }
      } catch (e) {
        console.warn('Failed to fetch video details:', e);
      }

      showStatus('üé¨ –í—ñ–¥–µ–æ –¥–æ–¥–∞–Ω–æ –≤ —Ñ–æ—Ä–º—É: ' + videoId, 'success');

    } else if (mode === 'ai') {
      // AI mode: use Gemini to generate article from video
      var geminiKey = localStorage.getItem('konopla_gemini_key');
      if (!geminiKey) {
        geminiKey = prompt('–í–≤–µ–¥—ñ—Ç—å Gemini API Key (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ):');
        if (!geminiKey) return;
        localStorage.setItem('konopla_gemini_key', geminiKey);
      }

      showStatus('‚è≥ AI –≥–µ–Ω–µ—Ä—É—î —Å—Ç–∞—Ç—Ç—é –∑ –≤—ñ–¥–µ–æ...', 'info');

      try {
        // 1. Fetch video details
        var ytKey = localStorage.getItem('konopla_yt_key');
        var detResp = await fetch('https://www.googleapis.com/youtube/v3/videos?part=snippet&id=' + videoId + '&key=' + encodeURIComponent(ytKey));
        if (!detResp.ok) throw new Error('Cannot fetch video details');

        var detData = await detResp.json();
        if (!detData.items || !detData.items.length) throw new Error('Video not found');

        var snippet = detData.items[0].snippet;
        var videoTitle = snippet.title || '';
        var videoDesc = snippet.description || '';
        var videoChannel = snippet.channelTitle || '';

        // 2. Send to Gemini for article generation
        var geminiPrompt = '–ù–∞ –æ—Å–Ω–æ–≤—ñ —Ü—å–æ–≥–æ YouTube –≤—ñ–¥–µ–æ –Ω–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—É —Å—Ç–∞—Ç—Ç—é —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é –¥–ª—è –Ω–æ–≤–∏–Ω–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞–ª—É –ø—Ä–æ –∫–æ–Ω–æ–ø–ª—ñ (–ø—Ä–æ–º–∏—Å–ª–æ–≤—ñ, –º–µ–¥–∏—á–Ω—ñ, –ª–µ–≥–∞–ª—ñ–∑–∞—Ü—ñ—è).\n\n' +
          '–í—ñ–¥–µ–æ: "' + videoTitle + '"\n' +
          '–ö–∞–Ω–∞–ª: ' + videoChannel + '\n' +
          '–û–ø–∏—Å: ' + videoDesc.slice(0, 1000) + '\n\n' +
          '–ü–æ–≤–µ—Ä–Ω–∏ JSON:\n' +
          '{\n  "title": "–∑–∞–≥–æ–ª–æ–≤–æ–∫ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é",\n  "summary": "1-2 —Ä–µ—á–µ–Ω–Ω—è –∞–Ω–æ–Ω—Å",\n  "body": "—Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ –≤ markdown (3-5 –∞–±–∑–∞—Ü—ñ–≤)",\n  "tags": ["—Ç–µ–≥1", "—Ç–µ–≥2"],\n  "category": "–æ–¥–Ω–∞ –∑: —Ç–µ–∫—Å—Ç–∏–ª—å, –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ, –∞–≥—Ä–æ, –±—ñ–æ–ø–ª–∞—Å—Ç–∏–∫, —Ö–∞—Ä—á–æ–≤–∞, –∞–≤—Ç–æ–ø—Ä–æ–º, –µ–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞, –∫–æ—Å–º–µ—Ç–∏–∫–∞, –Ω–∞—É–∫–∞, –µ–∫–æ–ª–æ–≥—ñ—è, –±—ñ–∑–Ω–µ—Å, –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–æ, –≤—ñ–¥–µ–æ, —ñ–Ω—à–µ"\n}\n\n' +
          '–í–ê–ñ–õ–ò–í–û: –Ø–∫—â–æ –≤—ñ–¥–µ–æ –ù–ï —Å—Ç–æ—Å—É—î—Ç—å—Å—è –∫–æ–Ω–æ–ø–ª—ñ–≤ ‚Äî –ø–æ–≤–µ—Ä–Ω–∏ {"rejected": true, "reason": "–ø—Ä–∏—á–∏–Ω–∞"}';

        var geminiResp = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + encodeURIComponent(geminiKey), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: geminiPrompt }] }],
            generationConfig: { temperature: 0.4, responseMimeType: 'application/json' }
          })
        });

        if (!geminiResp.ok) {
          if (geminiResp.status === 400 || geminiResp.status === 403) {
            localStorage.removeItem('konopla_gemini_key');
          }
          throw new Error('Gemini API error: ' + geminiResp.status);
        }

        var geminiData = await geminiResp.json();
        var aiText = geminiData.candidates[0].content.parts[0].text;
        var aiArticle = JSON.parse(aiText);

        if (aiArticle.rejected) {
          showStatus('üö´ AI –≤—ñ–¥—Ö–∏–ª–∏–≤: ' + (aiArticle.reason || '–Ω–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è –∫–æ–Ω–æ–ø–ª—ñ–≤'), 'error');
          return;
        }

        // 3. Fill create form with AI-generated content
        document.getElementById('create-form').style.display = 'block';
        initQuill();

        document.getElementById('cf-title').value = aiArticle.title || videoTitle;
        document.getElementById('cf-summary').value = aiArticle.summary || '';
        document.getElementById('cf-youtube').value = videoId;
        document.getElementById('cf-category').value = aiArticle.category || '–≤—ñ–¥–µ–æ';
        document.getElementById('cf-tags').value = (aiArticle.tags || []).join(', ');
        document.getElementById('cf-image').value = snippet.thumbnails.high ? snippet.thumbnails.high.url : '';

        // Set body in Quill
        if (quillEditor && aiArticle.body) {
          quillEditor.clipboard.dangerouslyPasteHTML(aiArticle.body.replace(/\n/g, '<br>'));
        }

        showStatus('ü§ñ AI —Å—Ç–∞—Ç—Ç—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∞! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–∞ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ.', 'success');

      } catch (e) {
        console.error('AI article error:', e);
        showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ AI: ' + e.message, 'error');
      }
    }
  };

  // UTF-8 safe base64 decode/encode
  function b64DecodeUtf8(b64) {
    var binStr = atob(b64.replace(/\s/g, ''));
    var bytes = new Uint8Array(binStr.length);
    for (var i = 0; i < binStr.length; i++) {
      bytes[i] = binStr.charCodeAt(i);
    }
    return new TextDecoder('utf-8').decode(bytes);
  }

  function b64EncodeUtf8(str) {
    var bytes = new TextEncoder().encode(str);
    var binStr = '';
    for (var i = 0; i < bytes.length; i++) {
      binStr += String.fromCharCode(bytes[i]);
    }
    return btoa(binStr);
  }

  async function ghApi(method, path, body) {
    var url = 'https://api.github.com/repos/' + GITHUB_REPO + path;
    var opts = {
      method: method,
      headers: {
        'Authorization': 'Bearer ' + ghToken,
        'Accept': 'application/vnd.github+json',
        'X-GitHub-Api-Version': '2022-11-28'
      }
    };
    if (body) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }
    return fetch(url, opts);
  }

  function showStatus(msg, type) {
    var el = document.getElementById('status-bar');
    el.textContent = msg;
    el.className = 'admin-status ' + (type || 'info');
    el.style.display = 'block';

    if (type === 'success') {
      setTimeout(function() {
        el.style.display = 'none';
      }, 5000);
    }
  }

  function escHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/\\/g, '&#92;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  function disableCard(card) {
    if (!card) return;
    card.style.opacity = '0.5';
    card.style.pointerEvents = 'none';
  }

  function enableCard(card) {
    if (!card) return;
    card.style.opacity = '1';
    card.style.pointerEvents = '';
  }

  // =========================================================================
  // Helpers: frontmatter parser, markdown-to-HTML, form reset
  // =========================================================================

  function parseFrontmatter(raw) {
    var match = raw.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
    if (!match) return null;
    var fmBlock = match[1];
    var body = match[2].trim();
    var fm = {};
    var lines = fmBlock.split('\n');
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i];
      var colonIdx = line.indexOf(':');
      if (colonIdx === -1) continue;
      var key = line.substring(0, colonIdx).trim();
      var val = line.substring(colonIdx + 1).trim();
      if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
        val = val.slice(1, -1);
      }
      if (val.startsWith('[') && val.endsWith(']')) {
        var inner = val.slice(1, -1);
        val = inner.split(',').map(function(s) {
          s = s.trim();
          if ((s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))) {
            s = s.slice(1, -1);
          }
          return s;
        }).filter(Boolean);
      }
      fm[key] = val;
    }
    return { frontmatter: fm, body: body };
  }

  function markdownToHtml(md) {
    if (!md) return '';
    var html = md
      .replace(/^---$/gm, '<hr>')
      .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    var blocks = html.split(/\n\n+/);
    var result = [];
    for (var i = 0; i < blocks.length; i++) {
      var block = blocks[i].trim();
      if (!block) continue;
      if (block === '<hr>') { result.push(block); continue; }
      if (block.match(/^>/m)) {
        var quoteLines = block.split('\n').map(function(l) { return l.replace(/^>\s?/, ''); });
        result.push('<blockquote>' + quoteLines.join('<br>') + '</blockquote>');
        continue;
      }
      if (block.match(/^- /m)) {
        var listItems = block.split('\n').map(function(l) {
          var m = l.match(/^- (.+)$/);
          return m ? '<li>' + m[1] + '</li>' : '';
        }).filter(Boolean);
        result.push('<ul>' + listItems.join('') + '</ul>');
        continue;
      }
      if (block.startsWith('<img ') || block.startsWith('<hr')) { result.push(block); continue; }
      result.push('<p>' + block.replace(/\n/g, '<br>') + '</p>');
    }
    return result.join('\n');
  }

  function resetCreateForm() {
    document.getElementById('cf-title').value = '';
    document.getElementById('cf-tags').value = '';
    document.getElementById('cf-summary').value = '';
    document.getElementById('cf-image').value = '';
    document.getElementById('cf-youtube').value = '';
    document.getElementById('cf-source-url').value = '';
    document.getElementById('cf-source').value = 'KONOPLA.UA';
    if (quillEditor) quillEditor.setText('');
    document.getElementById('create-form').style.display = 'none';
    var headerEl = document.querySelector('.create-form-header h2');
    if (headerEl) headerEl.textContent = String.fromCodePoint(0x270D, 0xFE0F) + ' ' + '–ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è';
    var submitBtn = document.querySelector('.cf-submit-btn');
    if (submitBtn) submitBtn.textContent = String.fromCodePoint(0x1F4DD) + ' ' + '–°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é';
    editingFile = null;
  }

  // =========================================================================
  // Create / Edit article (WYSIWYG)
  // =========================================================================

  var quillEditor = null;
  var turndownService = null;

  function initQuill() {
    if (quillEditor) return;
    quillEditor = new Quill('#cf-editor', {
      theme: 'snow',
      placeholder: '–ü–∏—à—ñ—Ç—å —Ç—É—Ç —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ...',
      modules: {
        toolbar: [
          [{ 'header': [2, 3, false] }],
          ['bold', 'italic'],
          ['blockquote'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'image'],
          ['clean']
        ]
      }
    });
    turndownService = new TurndownService({
      headingStyle: 'atx',
      bulletListMarker: '-',
      codeBlockStyle: 'fenced'
    });
    // Keep blockquotes as > in markdown
    turndownService.addRule('blockquote', {
      filter: 'blockquote',
      replacement: function(content) {
        var lines = content.trim().split('\n');
        return '\n' + lines.map(function(l) { return '> ' + l; }).join('\n') + '\n\n';
      }
    });
  }

  window.toggleCreateForm = function() {
    var form = document.getElementById('create-form');
    var visible = form.style.display !== 'none';
    if (visible) {
      resetCreateForm();
    } else {
      editingFile = null;
      var headerEl = document.querySelector('.create-form-header h2');
      if (headerEl) headerEl.textContent = String.fromCodePoint(0x270D, 0xFE0F) + ' –ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è';
      var submitBtn = document.querySelector('.cf-submit-btn');
      if (submitBtn) submitBtn.textContent = String.fromCodePoint(0x1F4DD) + ' –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é';
      form.style.display = 'block';
      initQuill();
    }
  };

  function slugifyUA(text) {
    var translit = {
      '–∞':'a','–±':'b','–≤':'v','–≥':'h','“ë':'g','–¥':'d','–µ':'e',
      '—î':'ye','–∂':'zh','–∑':'z','–∏':'y','—ñ':'i','—ó':'yi','–π':'y',
      '–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r',
      '—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts','—á':'ch',
      '—à':'sh','—â':'shch','—å':'','—é':'yu','—è':'ya','—ä':'','—ã':'y','—ç':'e'
    };
    var result = '';
    var lower = text.toLowerCase().trim();
    for (var i = 0; i < lower.length; i++) {
      var c = lower[i];
      if (translit[c] !== undefined) {
        result += translit[c];
      } else if (/[a-z0-9]/.test(c)) {
        result += c;
      } else if (c === ' ' || c === '_' || c === '.') {
        result += '-';
      } else if (c === '-') {
        result += '-';
      }
    }
    return result.replace(/-+/g, '-').replace(/^-|-$/g, '').slice(0, 80);
  }

  window.createArticle = async function() {
    var title = document.getElementById('cf-title').value.trim();
    var category = document.getElementById('cf-category').value;
    var tagsRaw = document.getElementById('cf-tags').value.trim();
    var summary = document.getElementById('cf-summary').value.trim();
    var imageUrl = document.getElementById('cf-image').value.trim();
    var youtubeId = document.getElementById('cf-youtube').value.trim();
    var source = document.getElementById('cf-source').value.trim() || 'KONOPLA.UA';
    var sourceUrl = document.getElementById('cf-source-url').value.trim();

    if (!title) { showStatus('‚ùå –í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫', 'error'); return; }
    if (!quillEditor || quillEditor.getText().trim().length < 10) {
      showStatus('‚ùå –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π', 'error'); return;
    }

    var html = quillEditor.root.innerHTML;
    var content = turndownService.turndown(html);

    var tags = tagsRaw ? tagsRaw.split(',').map(function(t) { return t.trim(); }).filter(Boolean) : [];
    var tagsStr = tags.map(function(t) { return '"' + t.replace(/"/g, "'") + '"'; }).join(', ');

    var isEdit = !!editingFile;
    var filename, dateStr;

    if (isEdit) {
      filename = editingFile.filename;
      dateStr = editingFile.date || new Date().toISOString().replace(/\.\d{3}Z$/, '+00:00');
    } else {
      var now = new Date();
      var pad = function(n) { return n.toString().padStart(2, '0'); };
      var datePrefix = now.getUTCFullYear().toString() +
        pad(now.getUTCMonth() + 1) + pad(now.getUTCDate()) + '-' +
        pad(now.getUTCHours()) + pad(now.getUTCMinutes());
      dateStr = now.toISOString().replace(/\.\d{3}Z$/, '+00:00');
      var slug = slugifyUA(title);
      filename = datePrefix + '-' + slug + '.md';
    }

    var fm = '---\n';
    fm += 'title: "' + title.replace(/"/g, "'") + '"\n';
    fm += 'date: ' + dateStr + '\n';
    fm += 'summary: "' + (summary || title).replace(/"/g, "'") + '"\n';
    fm += 'categories: ["' + category + '"]\n';
    fm += 'tags: [' + tagsStr + ']\n';
    fm += 'source: "' + source.replace(/"/g, "'") + '"\n';
    if (sourceUrl) fm += 'source_url: "' + sourceUrl + '"\n';
    if (imageUrl) fm += 'image: "' + imageUrl + '"\n';
    if (youtubeId) fm += 'youtube_id: "' + youtubeId + '"\n';
    fm += 'draft: ' + (isEdit ? (editingFile.draft || 'true') : 'false') + '\n';
    fm += '---\n\n';
    fm += content + '\n';

    showStatus(isEdit ? '‚è≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∑–º—ñ–Ω–∏...' : '‚è≥ –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞—Ç—Ç—é...', 'info');

    try {
      var encoded = b64EncodeUtf8(fm);
      var putBody = {
        message: (isEdit ? '‚úèÔ∏è Edit: ' : '‚úçÔ∏è Custom article: ') + filename,
        content: encoded
      };
      if (isEdit) putBody.sha = editingFile.sha;

      var resp = await ghApi('PUT', '/contents/content/news/' + filename, putBody);

      if (!resp.ok) {
        var err = await resp.json().catch(function() { return {}; });
        throw new Error(err.message || 'PUT failed: ' + resp.status);
      }

      if (isEdit) {
        // Update drafts.json if article was a draft
        if (editingFile.draft === 'true') {
          try {
            var dResp = await ghApi('GET', '/contents/data/drafts.json');
            if (dResp.ok) {
              var dData = await dResp.json();
              var dContent = JSON.parse(b64DecodeUtf8(dData.content));
              var dArticles = dContent.articles || [];
              for (var di = 0; di < dArticles.length; di++) {
                if (dArticles[di].filename === filename) {
                  dArticles[di].title = title;
                  dArticles[di].summary = summary;
                  dArticles[di].category = category;
                  if (imageUrl) dArticles[di].image = imageUrl;
                  break;
                }
              }
              var dEncoded = b64EncodeUtf8(JSON.stringify(dContent, null, 2));
              await ghApi('PUT', '/contents/data/drafts.json', {
                message: '‚úèÔ∏è Update draft: ' + filename,
                content: dEncoded,
                sha: dData.sha
              });
            }
          } catch (de) { console.warn('drafts.json update failed:', de); }
        }
        showStatus('‚úÖ –°—Ç–∞—Ç—Ç—é –æ–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
        resetCreateForm();
        loadDrafts();
      } else {
        var queueItem = {
          title: title,
          filename: filename,
          category: category,
          approvedAt: new Date().toISOString()
        };
        approvedQueue.push(queueItem);
        saveQueue();
        renderQueue();
        telegramQueue.push(Object.assign({}, queueItem));
        saveTgQueue();
        renderTgQueue();
        threadsQueue.push(Object.assign({}, queueItem));
        saveThreadsQueue();
        renderThreadsQueue();

        showStatus('‚úÖ –°—Ç–∞—Ç—Ç—è —Å—Ç–≤–æ—Ä–µ–Ω–∞ —Ç–∞ –¥–æ–¥–∞–Ω–∞ –≤ —É—Å—ñ —á–µ—Ä–≥–∏!', 'success');
        resetCreateForm();
      }

    } catch (e) {
      console.error('Save error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  // =========================================================================
  // Edit existing article
  // =========================================================================

  window.editArticle = async function(filename) {
    showStatus('‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–∞—Ç—Ç—é...', 'info');
    try {
      var fileResp = await ghApi('GET', '/contents/content/news/' + filename);
      if (!fileResp.ok) throw new Error('Cannot fetch file: ' + fileResp.status);
      var fileData = await fileResp.json();

      var raw = b64DecodeUtf8(fileData.content);
      var parsed = parseFrontmatter(raw);
      if (!parsed) throw new Error('Cannot parse frontmatter');
      var fm = parsed.frontmatter;
      var body = parsed.body;

      editingFile = {
        filename: filename,
        sha: fileData.sha,
        date: fm.date || new Date().toISOString(),
        draft: fm.draft || 'true'
      };

      document.getElementById('create-form').style.display = 'block';
      initQuill();

      var headerEl = document.querySelector('.create-form-header h2');
      if (headerEl) headerEl.textContent = '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ';
      var submitBtn = document.querySelector('.cf-submit-btn');
      if (submitBtn) submitBtn.textContent = 'üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏';

      document.getElementById('cf-title').value = fm.title || '';
      document.getElementById('cf-summary').value = fm.summary || '';
      document.getElementById('cf-image').value = fm.image || '';
      document.getElementById('cf-youtube').value = fm.youtube_id || '';
      document.getElementById('cf-source').value = fm.source || 'KONOPLA.UA';
      document.getElementById('cf-source-url').value = fm.source_url || '';

      var cat = Array.isArray(fm.categories) ? fm.categories[0] : (fm.categories || '—ñ–Ω—à–µ');
      document.getElementById('cf-category').value = cat;
      var tagsVal = Array.isArray(fm.tags) ? fm.tags.join(', ') : (fm.tags || '');
      document.getElementById('cf-tags').value = tagsVal;

      var bodyHtml = markdownToHtml(body);
      quillEditor.clipboard.dangerouslyPasteHTML(bodyHtml);

      showStatus('‚úèÔ∏è –°—Ç–∞—Ç—Ç—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è', 'success');
      document.getElementById('create-form').scrollIntoView({ behavior: 'smooth' });

    } catch (e) {
      console.error('Edit error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + e.message, 'error');
      editingFile = null;
    }
  };

  // =========================================================================
  // Auto-format with AI
  // =========================================================================

  window.autoFormat = async function() {
    var geminiKey = localStorage.getItem('konopla_gemini_key');
    if (!geminiKey) {
      geminiKey = prompt('–í–≤–µ–¥—ñ—Ç—å Gemini API Key (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ):');
      if (!geminiKey) return;
      localStorage.setItem('konopla_gemini_key', geminiKey);
    }

    if (!quillEditor) { showStatus('‚ùå –†–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π', 'error'); return; }

    var rawText = quillEditor.getText().trim();
    if (rawText.length < 20) {
      showStatus('‚ùå –í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è (–º—ñ–Ω—ñ–º—É–º 20 —Å–∏–º–≤–æ–ª—ñ–≤)', 'error');
      return;
    }

    var existingTitle = document.getElementById('cf-title').value.trim();
    var userPrompt = '–ü–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç—É–π —Ü–µ–π —Ç–µ–∫—Å—Ç —É –∂—É—Ä–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∏–ª—ñ:\n\n';
    if (existingTitle) userPrompt += '–ó–∞–≥–æ–ª–æ–≤–æ–∫: ' + existingTitle + '\n\n';
    userPrompt += '–¢–µ–∫—Å—Ç:\n' + rawText;

    var btn = document.getElementById('btn-autoformat');
    var originalBtnText = btn.textContent;
    btn.textContent = '‚è≥ AI –æ–±—Ä–æ–±–ª—è—î...';
    btn.disabled = true;
    showStatus('‚è≥ AI —Ñ–æ—Ä–º–∞—Ç—É—î —Ç–µ–∫—Å—Ç... (10-30 —Å–µ–∫)', 'info');

    try {
      var geminiResp = await fetch(
        'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + encodeURIComponent(geminiKey),
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: AUTOFORMAT_PROMPT + '\n\n' + userPrompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 8192, responseMimeType: 'application/json' }
          })
        }
      );

      if (!geminiResp.ok) {
        if (geminiResp.status === 400 || geminiResp.status === 403) localStorage.removeItem('konopla_gemini_key');
        throw new Error('Gemini API error: ' + geminiResp.status);
      }

      var geminiData = await geminiResp.json();
      var aiText = geminiData.candidates[0].content.parts[0].text;
      aiText = aiText.replace(/^```json\s*/, '').replace(/\s*```$/, '').trim();
      var aiResult = JSON.parse(aiText);

      if (aiResult.rejected) {
        showStatus('üö´ AI –≤—ñ–¥—Ö–∏–ª–∏–≤: ' + (aiResult.reason || '–Ω–µ–≤—ñ–¥–æ–º–∞ –ø—Ä–∏—á–∏–Ω–∞'), 'error');
        return;
      }

      if (aiResult.title) document.getElementById('cf-title').value = aiResult.title;
      if (aiResult.summary) document.getElementById('cf-summary').value = aiResult.summary;
      if (aiResult.category) document.getElementById('cf-category').value = aiResult.category;
      if (aiResult.tags && Array.isArray(aiResult.tags)) {
        document.getElementById('cf-tags').value = aiResult.tags.join(', ');
      }

      if (aiResult.content) {
        var formattedHtml = markdownToHtml(aiResult.content);
        quillEditor.clipboard.dangerouslyPasteHTML(formattedHtml);
      }

      showStatus('‚ú® –¢–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–∞ –≤—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏.', 'success');

    } catch (e) {
      console.error('Autoformat error:', e);
      if (e instanceof SyntaxError) {
        showStatus('‚ùå AI –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.', 'error');
      } else {
        showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è: ' + e.message, 'error');
      }
    } finally {
      btn.textContent = originalBtnText;
      btn.disabled = false;
    }
  };

  // =========================================================================
  // All articles list (paginated)
  // =========================================================================

  var ARTICLES_PER_PAGE = 20;
  var articlesPage = 1;

  function renderArticles() {
    ALL_ARTICLES.sort(function(a, b) {
      return (b.date || '').localeCompare(a.date || '');
    });

    var cats = {};
    ALL_ARTICLES.forEach(function(a) { if (a.category) cats[a.category] = true; });
    var catSelect = document.getElementById('articles-filter-cat');
    if (catSelect) {
      var catKeys = Object.keys(cats).sort();
      catSelect.innerHTML = '<option value="all">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>';
      catKeys.forEach(function(c) {
        catSelect.innerHTML += '<option value="' + escHtml(c) + '">' + escHtml(c) + '</option>';
      });
    }

    articlesPage = 1;
    filterArticles();
  }

  window.articlesGoTo = function(page) {
    articlesPage = page;
    filterArticles();
    var sec = document.getElementById('articles-section');
    if (sec) sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  window.filterArticles = function(resetPage) {
    if (resetPage !== false) articlesPage = 1;

    var query = (document.getElementById('articles-search').value || '').toLowerCase();
    var status = document.getElementById('articles-filter-status').value;
    var cat = document.getElementById('articles-filter-cat').value;

    var filtered = ALL_ARTICLES.filter(function(a) {
      if (status === 'published' && a.draft) return false;
      if (status === 'draft' && !a.draft) return false;
      if (cat !== 'all' && a.category !== cat) return false;
      if (query && (a.title || '').replace(/^"+|"+$/g, '').toLowerCase().indexOf(query) === -1 &&
          (a.category || '').toLowerCase().indexOf(query) === -1) return false;
      return true;
    });

    var total = filtered.length;
    var totalPages = Math.ceil(total / ARTICLES_PER_PAGE) || 1;
    if (articlesPage > totalPages) articlesPage = totalPages;

    var start = (articlesPage - 1) * ARTICLES_PER_PAGE;
    var pageItems = filtered.slice(start, start + ARTICLES_PER_PAGE);

    document.getElementById('articles-count').textContent = total;

    var listEl = document.getElementById('articles-list');
    if (!listEl) return;

    if (total === 0) {
      listEl.innerHTML = '<div style="padding:1rem;color:var(--text-muted);text-align:center;">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
      return;
    }

    var rows = pageItems.map(function(a) {
      var statusClass = a.draft ? 'draft' : 'published';
      var statusText = a.draft ? '–ß–µ—Ä–Ω–µ—Ç–∫–∞' : '–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ';
      var slug = a.filename.replace('.md', '');
      var cleanTitle = (a.title || '').replace(/^"+|"+$/g, '');
      var isPinned = (a.filename === PINNED_FILENAME);

      var pinBtn = '';
      if (!a.draft) {
        if (isPinned) {
          pinBtn = '<button class="admin-btn btn-unpin" onclick="unpinArticle()">' + String.fromCodePoint(128204) + '</button>';
        } else {
          pinBtn = '<button class="admin-btn btn-pin" onclick="pinArticle(\'' + escHtml(a.filename) + '\')">' + String.fromCodePoint(128204) + '</button>';
        }
      }

      var pinnedLabel = isPinned ? ' <span class="pinned-info">' + String.fromCodePoint(128204) + ' –ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ</span>' : '';

      return '<div class="article-row">' +
        '<span class="article-date">' + escHtml(a.date) + '</span>' +
        '<span class="article-status ' + statusClass + '">' + statusText + '</span>' +
        '<span class="article-category">' + escHtml(a.category || '') + '</span>' +
        '<span class="article-title"><a href="/news/' + escHtml(slug) + '/" target="_blank">' + escHtml(cleanTitle) + '</a>' + pinnedLabel + '</span>' +
        '<span class="article-actions">' +
          pinBtn +
          '<button class="admin-btn btn-edit" onclick="editArticle(\'' + escHtml(a.filename) + '\')">' + String.fromCodePoint(9999, 65039) + '</button>' +
          '<a href="/news/' + escHtml(slug) + '/" target="_blank" class="admin-btn">' + String.fromCodePoint(128065) + '</a>' +
        '</span>' +
      '</div>';
    }).join('');

    // Pagination controls
    var pager = '';
    if (totalPages > 1) {
      pager = '<div class="articles-pager">';
      pager += '<button class="admin-btn admin-btn-dim" onclick="articlesGoTo(' + (articlesPage - 1) + ')"' + (articlesPage <= 1 ? ' disabled' : '') + '>&laquo;</button>';

      var startP = Math.max(1, articlesPage - 2);
      var endP = Math.min(totalPages, startP + 4);
      if (endP - startP < 4) startP = Math.max(1, endP - 4);

      for (var p = startP; p <= endP; p++) {
        if (p === articlesPage) {
          pager += '<button class="admin-btn articles-page-active">' + p + '</button>';
        } else {
          pager += '<button class="admin-btn admin-btn-dim" onclick="articlesGoTo(' + p + ')">' + p + '</button>';
        }
      }

      pager += '<button class="admin-btn admin-btn-dim" onclick="articlesGoTo(' + (articlesPage + 1) + ')"' + (articlesPage >= totalPages ? ' disabled' : '') + '>&raquo;</button>';
      pager += '<span class="articles-page-info">' + articlesPage + ' / ' + totalPages + '</span>';
      pager += '</div>';
    }

    listEl.innerHTML = rows + pager;
  };

  // =========================================================================
  // Pin / Unpin article
  // =========================================================================

  window.pinArticle = async function(filename) {
    if (!ghToken) { showStatus(String.fromCodePoint(10060) + ' GitHub PAT –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ', 'error'); return; }
    if (!confirm('–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ?')) return;

    showStatus(String.fromCodePoint(9203) + ' –ó–∞–∫—Ä—ñ–ø–ª—é—î–º–æ —Å—Ç–∞—Ç—Ç—é...', 'info');

    try {
      var resp = await ghApi('GET', '/contents/data/pinned.json');
      var sha = '';
      if (resp.ok) {
        var data = await resp.json();
        sha = data.sha;
      }

      var pinData = JSON.stringify({ filename: filename, pinned_at: new Date().toISOString() }, null, 2);
      var putBody = {
        message: String.fromCodePoint(128204) + ' Pin: ' + filename,
        content: b64EncodeUtf8(pinData)
      };
      if (sha) putBody.sha = sha;

      var putResp = await ghApi('PUT', '/contents/data/pinned.json', putBody);
      if (!putResp.ok) throw new Error('PUT failed: ' + putResp.status);

      PINNED_FILENAME = filename;
      filterArticles();
      showStatus(String.fromCodePoint(128204) + ' –°—Ç–∞—Ç—Ç—é –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ! –ó–º—ñ–Ω–∏ –∑\'—è–≤–ª—è—Ç—å—Å—è –ø—ñ—Å–ª—è –¥–µ–ø–ª–æ—é.', 'success');
    } catch (e) {
      console.error('Pin error:', e);
      showStatus(String.fromCodePoint(10060) + ' –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  window.unpinArticle = async function() {
    if (!ghToken) { showStatus(String.fromCodePoint(10060) + ' GitHub PAT –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ', 'error'); return; }
    if (!confirm('–í—ñ–¥–∫—Ä—ñ–ø–∏—Ç–∏ —Å—Ç–∞—Ç—Ç—é?')) return;

    showStatus(String.fromCodePoint(9203) + ' –í—ñ–¥–∫—Ä—ñ–ø–ª—é—î–º–æ...', 'info');

    try {
      var resp = await ghApi('GET', '/contents/data/pinned.json');
      if (!resp.ok) throw new Error('GET failed: ' + resp.status);
      var data = await resp.json();

      var pinData = JSON.stringify({ filename: '', pinned_at: '' }, null, 2);
      var putResp = await ghApi('PUT', '/contents/data/pinned.json', {
        message: String.fromCodePoint(128204) + ' Unpin article',
        content: b64EncodeUtf8(pinData),
        sha: data.sha
      });
      if (!putResp.ok) throw new Error('PUT failed: ' + putResp.status);

      PINNED_FILENAME = '';
      filterArticles();
      showStatus(String.fromCodePoint(9989) + ' –°—Ç–∞—Ç—Ç—é –≤—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–æ!', 'success');
    } catch (e) {
      console.error('Unpin error:', e);
      showStatus(String.fromCodePoint(10060) + ' –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
    }
  };

  window.generateImage = async function() {
    var geminiKey = localStorage.getItem('konopla_gemini_key');
    if (!geminiKey) {
      geminiKey = prompt('–í–≤–µ–¥—ñ—Ç—å Gemini API Key (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ):');
      if (!geminiKey) return;
      localStorage.setItem('konopla_gemini_key', geminiKey);
    }

    if (!ghToken) { showStatus('‚ùå –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ GitHub PAT', 'error'); return; }

    var textSource = '';
    if (quillEditor && quillEditor.getText().trim().length > 10) {
      textSource = quillEditor.getText().trim().substring(0, 500);
    }
    var titleVal = document.getElementById('cf-title').value.trim();
    if (!textSource && !titleVal) {
      showStatus('‚ùå –í–≤–µ–¥—ñ—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–±–æ —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è', 'error');
      return;
    }

    var imagePrompt = 'Generate a high-quality photo-realistic image for a news article. ' +
      'The image MUST be in wide landscape format with exact 16:9 aspect ratio (1280x720 resolution). ' +
      'Make it look professional, cinematic, suitable for a premium news website about industrial hemp. ' +
      'Do NOT include any text, watermarks, logos, or UI elements in the image. ' +
      'Topic: ' + (titleVal || textSource.substring(0, 200));

    var btn = document.getElementById('btn-genimage');
    var originalBtnText = btn.textContent;
    btn.textContent = String.fromCodePoint(9203) + ' –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è...';
    btn.disabled = true;
    showStatus(String.fromCodePoint(9203) + ' AI –≥–µ–Ω–µ—Ä—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è... (15-40 —Å–µ–∫)', 'info');

    try {
      var geminiResp = await fetch(
        'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image:generateContent?key=' + encodeURIComponent(geminiKey),
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: imagePrompt }] }],
            generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
          })
        }
      );

      if (!geminiResp.ok) {
        if (geminiResp.status === 400 || geminiResp.status === 403) localStorage.removeItem('konopla_gemini_key');
        throw new Error('Gemini API error: ' + geminiResp.status);
      }

      var geminiData = await geminiResp.json();
      var parts = geminiData.candidates[0].content.parts;
      var imageB64 = null;
      for (var pi = 0; pi < parts.length; pi++) {
        if (parts[pi].inlineData) {
          imageB64 = parts[pi].inlineData.data;
          break;
        }
      }

      if (!imageB64) throw new Error('Gemini –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');

      // Generate unique filename
      var imgId = Date.now().toString(36) + Math.random().toString(36).substring(2, 6);
      var imgFilename = 'gen-' + imgId + '.jpg';
      var imgPath = 'static/images/generated/' + imgFilename;

      showStatus(String.fromCodePoint(9203) + ' –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π...', 'info');

      var putResp = await ghApi('PUT', '/contents/' + imgPath, {
        message: String.fromCodePoint(128248) + ' Generated image: ' + imgFilename,
        content: imageB64
      });

      if (!putResp.ok) {
        var errData = await putResp.json().catch(function() { return {}; });
        throw new Error(errData.message || 'Upload failed: ' + putResp.status);
      }

      var imageUrl = '/images/generated/' + imgFilename;
      document.getElementById('cf-image').value = imageUrl;
      showStatus(String.fromCodePoint(9989) + ' –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!', 'success');

    } catch (e) {
      console.error('Image generation error:', e);
      showStatus(String.fromCodePoint(10060) + ' –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó: ' + e.message, 'error');
    } finally {
      btn.textContent = originalBtnText;
      btn.disabled = false;
    }
  };

  // Expose for onclick
  window.logout = logout;

  // Init
  init();

})();
</script>
{{ end }}
