{{ define "main" }}
<div class="container">
  <div id="admin-app">

    <!-- Auth screen -->
    <div id="auth-screen" class="admin-auth">
      <div class="auth-card">
        <h1>üîê –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <p>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É</p>
        <form id="auth-form">
          <input type="password" id="auth-key" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off" class="auth-input">
          <button type="submit" class="auth-btn">–£–≤—ñ–π—Ç–∏</button>
        </form>
        <p id="auth-error" class="auth-error" style="display:none">–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å</p>
      </div>
    </div>

    <!-- Admin panel (hidden until auth) -->
    <div id="admin-panel" style="display:none">
      <div class="admin-header">
        <h1>üåø KONOPLA.UA ‚Äî –ú–æ–¥–µ—Ä–∞—Ü—ñ—è</h1>
        <div class="admin-actions-top">
          <button id="btn-refresh" class="admin-btn" onclick="loadDrafts()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
          <button id="btn-run-pipeline" class="admin-btn admin-btn-green" onclick="runPipeline()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–±—ñ—Ä</button>
          <button id="btn-logout" class="admin-btn admin-btn-dim" onclick="logout()">–í–∏–π—Ç–∏</button>
        </div>
      </div>

      <div id="status-bar" class="admin-status" style="display:none"></div>

      <div id="drafts-list" class="drafts-list">
        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      </div>

      <div id="empty-state" class="admin-empty" style="display:none">
        <h2>üì≠ –ù–µ–º–∞—î —Å—Ç–∞—Ç–µ–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó</h2>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–±—ñ—Ä¬ª –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –Ω–æ–≤–∏–Ω</p>
      </div>

      <!-- Deploy queue -->
      <div id="deploy-queue" class="deploy-queue" style="display:none">
        <div class="deploy-queue-header">
          <h2>üöÄ –ß–µ—Ä–≥–∞ –Ω–∞ –¥–µ–ø–ª–æ–π</h2>
          <div class="deploy-queue-actions">
            <button class="admin-btn admin-btn-green" onclick="deployAll()">üöÄ –ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ (<span id="queue-count">0</span>)</button>
            <button class="admin-btn admin-btn-dim" onclick="clearQueue()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
        <div id="queue-items" class="queue-items"></div>
      </div>
    </div>

  </div>
</div>

<style>
/* Admin Auth */
.admin-auth {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 60vh;
}
.auth-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 3rem;
  text-align: center;
  max-width: 400px;
  width: 100%;
}
.auth-card h1 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}
.auth-card p {
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
}
.auth-input {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 1rem;
  margin-bottom: 1rem;
  outline: none;
  transition: border-color var(--transition);
}
.auth-input:focus {
  border-color: var(--green-accent);
}
.auth-btn {
  width: 100%;
  padding: 0.75rem;
  background: var(--green-accent);
  color: #000;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background var(--transition);
}
.auth-btn:hover {
  background: var(--green-hover);
}
.auth-error {
  color: #ef4444;
  margin-top: 1rem;
  font-size: 0.875rem;
}

/* Admin Panel */
.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.admin-header h1 {
  font-size: 1.5rem;
}
.admin-actions-top {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.admin-btn {
  padding: 0.5rem 1rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.admin-btn:hover {
  border-color: var(--border-hover);
  background: var(--bg-elevated);
}
.admin-btn-green {
  background: var(--green-dim);
  border-color: var(--green-accent);
  color: var(--green-accent);
}
.admin-btn-green:hover {
  background: var(--green-accent);
  color: #000;
}
.admin-btn-dim {
  color: var(--text-secondary);
}
.admin-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Status bar */
.admin-status {
  padding: 0.75rem 1rem;
  border-radius: var(--radius-sm);
  margin-bottom: 1.5rem;
  font-size: 0.875rem;
  animation: fadeIn 0.3s;
}
.admin-status.info {
  background: rgba(59, 130, 246, 0.15);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #93c5fd;
}
.admin-status.success {
  background: var(--green-dim);
  border: 1px solid rgba(52, 211, 153, 0.3);
  color: var(--green-accent);
}
.admin-status.error {
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #fca5a5;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Drafts list */
.drafts-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.loading {
  text-align: center;
  padding: 3rem;
  color: var(--text-secondary);
}
.admin-empty {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--text-secondary);
}
.admin-empty h2 {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

/* Draft card */
.draft-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: border-color var(--transition);
}
.draft-card:hover {
  border-color: var(--border-hover);
}
.draft-card-inner {
  display: flex;
  gap: 1.5rem;
  padding: 1.25rem;
}
.draft-image {
  width: 160px;
  height: 100px;
  border-radius: var(--radius-sm);
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg-tertiary);
}
.draft-image-placeholder {
  width: 160px;
  height: 100px;
  border-radius: var(--radius-sm);
  background: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  flex-shrink: 0;
}
.draft-info {
  flex: 1;
  min-width: 0;
}
.draft-title {
  font-size: 1.05rem;
  font-weight: 600;
  margin-bottom: 0.35rem;
  line-height: 1.3;
}
.draft-title a {
  color: var(--text-primary);
  text-decoration: none;
}
.draft-title a:hover {
  color: var(--green-accent);
}
.draft-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}
.draft-summary {
  font-size: 0.875rem;
  color: var(--text-secondary);
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.draft-actions {
  display: flex;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  border-top: 1px solid var(--divider);
  background: rgba(0,0,0,0.2);
}
.draft-actions .admin-btn {
  font-size: 0.8rem;
  padding: 0.4rem 0.75rem;
}
.btn-approve {
  background: var(--green-dim) !important;
  border-color: var(--green-accent) !important;
  color: var(--green-accent) !important;
}
.btn-approve:hover {
  background: var(--green-accent) !important;
  color: #000 !important;
}
.btn-delete {
  color: #ef4444 !important;
  border-color: rgba(239, 68, 68, 0.3) !important;
  background: rgba(239, 68, 68, 0.1) !important;
}
.btn-delete:hover {
  background: #ef4444 !important;
  color: #fff !important;
}

/* GitHub PAT setup */
.pat-setup {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}
.pat-setup h3 {
  font-size: 1rem;
  margin-bottom: 0.5rem;
}
.pat-setup p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}
.pat-input-row {
  display: flex;
  gap: 0.5rem;
}
.pat-input-row input {
  flex: 1;
  padding: 0.5rem 0.75rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: 0.875rem;
  outline: none;
}
.pat-input-row input:focus {
  border-color: var(--green-accent);
}

/* Deploy queue */
.deploy-queue {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 2px solid var(--green-accent);
}
.deploy-queue-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1rem;
}
.deploy-queue-header h2 {
  font-size: 1.15rem;
  color: var(--green-accent);
}
.deploy-queue-actions {
  display: flex;
  gap: 0.5rem;
}
.queue-items {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.queue-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.6rem 1rem;
  background: var(--green-subtle);
  border: 1px solid rgba(52, 211, 153, 0.15);
  border-radius: var(--radius-sm);
  font-size: 0.875rem;
}
.queue-item-title {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--text-primary);
}
.queue-item-cat {
  color: var(--text-secondary);
  font-size: 0.8rem;
  margin-left: 1rem;
  flex-shrink: 0;
}
.queue-item-remove {
  margin-left: 0.75rem;
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.8rem;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  flex-shrink: 0;
}
.queue-item-remove:hover {
  color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}

/* Responsive */
@media (max-width: 640px) {
  .draft-card-inner {
    flex-direction: column;
    gap: 1rem;
  }
  .draft-image, .draft-image-placeholder {
    width: 100%;
    height: 180px;
  }
  .admin-header {
    flex-direction: column;
    align-items: flex-start;
  }
  .admin-actions-top {
    width: 100%;
  }
  .admin-actions-top .admin-btn {
    flex: 1;
    text-align: center;
  }
}
</style>

<script>
(function() {
  'use strict';

  var ADMIN_KEY_HASH = '{{ .Site.Params.admin_key_hash }}';
  var GITHUB_REPO = '{{ .Site.Params.github_repo }}';
  var SITE_URL = '{{ .Site.BaseURL }}';

  var ghToken = '';
  var adminKey = '';
  var approvedQueue = [];

  // =========================================================================
  // Auth
  // =========================================================================

  function init() {
    // Check URL param
    var params = new URLSearchParams(window.location.search);
    var key = params.get('key');
    if (key) {
      checkAuth(key);
      return;
    }

    // Check localStorage
    var saved = localStorage.getItem('konopla_admin_key');
    if (saved) {
      checkAuth(saved);
      return;
    }

    showAuth();
  }

  function showAuth() {
    document.getElementById('auth-screen').style.display = 'flex';
    document.getElementById('admin-panel').style.display = 'none';
  }

  function showPanel() {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('admin-panel').style.display = 'block';

    // Load GitHub PAT from localStorage
    ghToken = localStorage.getItem('konopla_gh_token') || '';

    // Load deploy queue from localStorage
    loadQueue();
    renderQueue();

    if (!ghToken) {
      showPatSetup();
    } else {
      loadDrafts();
    }
  }

  async function checkAuth(key) {
    var hash = await sha256(key);
    if (hash === ADMIN_KEY_HASH) {
      adminKey = key;
      localStorage.setItem('konopla_admin_key', key);
      // Clean URL
      if (window.location.search) {
        window.history.replaceState({}, '', window.location.pathname);
      }
      showPanel();
    } else {
      localStorage.removeItem('konopla_admin_key');
      showAuth();
      document.getElementById('auth-error').style.display = 'block';
    }
  }

  function logout() {
    localStorage.removeItem('konopla_admin_key');
    localStorage.removeItem('konopla_gh_token');
    adminKey = '';
    ghToken = '';
    showAuth();
  }

  async function sha256(str) {
    var buf = new TextEncoder().encode(str);
    var hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
  }

  // Auth form handler
  document.getElementById('auth-form').addEventListener('submit', function(e) {
    e.preventDefault();
    var key = document.getElementById('auth-key').value.trim();
    if (key) checkAuth(key);
  });

  // =========================================================================
  // GitHub PAT setup
  // =========================================================================

  function showPatSetup() {
    var el = document.getElementById('drafts-list');
    el.innerHTML = '<div class="pat-setup">' +
      '<h3>üîë GitHub Token</h3>' +
      '<p>–î–ª—è –º–æ–¥–µ—Ä–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–µ–Ω GitHub Personal Access Token (fine-grained) –∑ –ø—Ä–∞–≤–∞–º–∏ <code>contents:write</code> —Ç–∞ <code>actions:write</code> –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é <code>' + GITHUB_REPO + '</code>.</p>' +
      '<div class="pat-input-row">' +
        '<input type="password" id="pat-input" placeholder="github_pat_...">' +
        '<button class="admin-btn admin-btn-green" onclick="saveToken()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>' +
      '</div>' +
    '</div>';
  }

  window.saveToken = function() {
    var token = document.getElementById('pat-input').value.trim();
    if (!token) return;
    ghToken = token;
    localStorage.setItem('konopla_gh_token', token);
    showStatus('Token –∑–±–µ—Ä–µ–∂–µ–Ω–æ!', 'success');
    loadDrafts();
  };

  // =========================================================================
  // Load drafts
  // =========================================================================

  window.loadDrafts = async function() {
    if (!ghToken) {
      showPatSetup();
      return;
    }

    var el = document.getElementById('drafts-list');
    el.innerHTML = '<div class="loading">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
    document.getElementById('empty-state').style.display = 'none';

    try {
      // Fetch drafts.json from repo
      var resp = await ghApi('GET', '/contents/data/drafts.json');

      if (resp.status === 404) {
        el.innerHTML = '';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      if (!resp.ok) throw new Error('GitHub API error: ' + resp.status);

      var data = await resp.json();
      var content = JSON.parse(b64DecodeUtf8(data.content));
      var articles = (content.articles || []).filter(function(a) { return a && a.filename; });

      if (articles.length === 0) {
        el.innerHTML = '';
        document.getElementById('empty-state').style.display = 'block';
        return;
      }

      // Sort newest first
      articles.sort(function(a, b) {
        return (b.created_at || '').localeCompare(a.created_at || '');
      });

      el.innerHTML = articles.map(function(a) {
        var img = a.image
          ? '<img src="' + escHtml(a.image) + '" alt="" class="draft-image">'
          : '<div class="draft-image-placeholder">üì∞</div>';

        var cat = a.category || '';
        var date = a.created_at ? new Date(a.created_at).toLocaleString('uk-UA') : '';

        return '<div class="draft-card" data-filename="' + escHtml(a.filename) + '" data-id="' + escHtml(a.id) + '">' +
          '<div class="draft-card-inner">' +
            img +
            '<div class="draft-info">' +
              '<h3 class="draft-title"><a href="/news/' + escHtml(a.filename.replace('.md', '')) + '/" target="_blank">' + escHtml(a.title) + '</a></h3>' +
              '<div class="draft-meta"><span>' + escHtml(cat) + '</span><span>' + escHtml(date) + '</span></div>' +
              '<p class="draft-summary">' + escHtml(a.summary || '') + '</p>' +
            '</div>' +
          '</div>' +
          '<div class="draft-actions">' +
            '<button class="admin-btn btn-approve" onclick="approveArticle(\'' + escHtml(a.filename) + '\', \'' + escHtml(a.id) + '\')">‚úÖ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>' +
            '<button class="admin-btn btn-delete" onclick="deleteArticle(\'' + escHtml(a.filename) + '\', \'' + escHtml(a.id) + '\')">‚ùå –í–∏–¥–∞–ª–∏—Ç–∏</button>' +
            '<a href="/news/' + escHtml(a.filename.replace('.md', '')) + '/" target="_blank" class="admin-btn">üëÅ Preview</a>' +
          '</div>' +
        '</div>';
      }).join('');

    } catch (e) {
      console.error('Load error:', e);
      el.innerHTML = '<div class="loading">‚ùå –ü–æ–º–∏–ª–∫–∞: ' + escHtml(e.message) + '</div>';

      if (e.message && e.message.indexOf('401') !== -1) {
        localStorage.removeItem('konopla_gh_token');
        ghToken = '';
        showPatSetup();
      }
    }
  };

  // =========================================================================
  // Approve article: change draft:true ‚Üí draft:false
  // =========================================================================

  window.approveArticle = async function(filename, articleId) {
    if (!confirm('–°—Ö–≤–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é?')) return;

    var card = document.querySelector('[data-filename="' + filename + '"]');
    // Get title from card before disabling
    var titleEl = card ? card.querySelector('.draft-title a') : null;
    var title = titleEl ? titleEl.textContent : filename;
    var catEl = card ? card.querySelector('.draft-meta span') : null;
    var category = catEl ? catEl.textContent : '';

    disableCard(card);
    showStatus('‚è≥ –°—Ö–≤–∞–ª—é—î–º–æ...', 'info');

    try {
      // 1. Get the .md file
      var fileResp = await ghApi('GET', '/contents/content/news/' + filename);
      if (!fileResp.ok) throw new Error('Cannot fetch file: ' + fileResp.status);
      var fileData = await fileResp.json();

      // 2. Decode content, replace draft: true ‚Üí draft: false
      var decoded = b64DecodeUtf8(fileData.content);
      var updated = decoded.replace(/^draft:\s*true$/m, 'draft: false');

      if (updated === decoded) {
        showStatus('‚ö†Ô∏è –§–∞–π–ª –≤–∂–µ –Ω–µ draft –∞–±–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ draft: true', 'error');
        enableCard(card);
        return;
      }

      // 3. PUT updated file back
      var putResp = await ghApi('PUT', '/contents/content/news/' + filename, {
        message: '‚úÖ Approve: ' + filename,
        content: b64EncodeUtf8(updated),
        sha: fileData.sha
      });

      if (!putResp.ok) {
        var err = await putResp.json().catch(function() { return {}; });
        throw new Error('PUT failed: ' + (err.message || putResp.status));
      }

      // 4. Remove from drafts.json
      await removeDraftEntry(articleId);

      // 5. Add to deploy queue (NO deploy yet!)
      approvedQueue.push({
        title: title,
        filename: filename,
        category: category,
        approvedAt: new Date().toISOString()
      });
      saveQueue();
      renderQueue();

      showStatus('‚úÖ –°—Ö–≤–∞–ª–µ–Ω–æ! –î–æ–¥–∞–Ω–æ –≤ —á–µ—Ä–≥—É –Ω–∞ –¥–µ–ø–ª–æ–π.', 'success');

      // Remove card from UI
      if (card) card.remove();

      // Check if list is empty
      var remaining = document.querySelectorAll('.draft-card');
      if (remaining.length === 0) {
        document.getElementById('empty-state').style.display = 'block';
      }

    } catch (e) {
      console.error('Approve error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
      enableCard(card);
    }
  };

  // =========================================================================
  // Delete article
  // =========================================================================

  window.deleteArticle = async function(filename, articleId) {
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å—Ç–∞—Ç—Ç—é? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;

    var card = document.querySelector('[data-filename="' + filename + '"]');
    disableCard(card);
    showStatus('‚è≥ –í–∏–¥–∞–ª—è—î–º–æ...', 'info');

    try {
      // 1. Get file SHA
      var fileResp = await ghApi('GET', '/contents/content/news/' + filename);
      if (!fileResp.ok && fileResp.status !== 404) throw new Error('Cannot fetch file: ' + fileResp.status);

      if (fileResp.ok) {
        var fileData = await fileResp.json();

        // 2. Delete file
        var delResp = await ghApi('DELETE', '/contents/content/news/' + filename, {
          message: '‚ùå Delete: ' + filename,
          sha: fileData.sha
        });

        if (!delResp.ok) {
          var err = await delResp.json().catch(function() { return {}; });
          throw new Error('DELETE failed: ' + (err.message || delResp.status));
        }
      }

      // 3. Remove from drafts.json
      await removeDraftEntry(articleId);

      showStatus('üóëÔ∏è –°—Ç–∞—Ç—Ç—è –≤–∏–¥–∞–ª–µ–Ω–∞.', 'success');

      if (card) card.remove();

      var remaining = document.querySelectorAll('.draft-card');
      if (remaining.length === 0) {
        document.getElementById('empty-state').style.display = 'block';
      }

    } catch (e) {
      console.error('Delete error:', e);
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
      enableCard(card);
    }
  };

  // =========================================================================
  // Run pipeline
  // =========================================================================

  window.runPipeline = async function() {
    if (!ghToken) {
      showStatus('‚ùå –ü–æ—Ç—Ä—ñ–±–µ–Ω GitHub Token', 'error');
      return;
    }

    showStatus('‚è≥ –ó–∞–ø—É—Å–∫ pipeline...', 'info');
    document.getElementById('btn-run-pipeline').disabled = true;

    try {
      var resp = await ghApi('POST', '/actions/workflows/pipeline.yml/dispatches', {
        ref: 'main'
      });

      if (resp.status === 204 || resp.ok) {
        showStatus('üöÄ Pipeline –∑–∞–ø—É—â–µ–Ω–æ! –ù–æ–≤—ñ —Å—Ç–∞—Ç—Ç—ñ –∑\'—è–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω.', 'success');
      } else {
        throw new Error('Status: ' + resp.status);
      }
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É: ' + e.message, 'error');
    }

    setTimeout(function() {
      document.getElementById('btn-run-pipeline').disabled = false;
    }, 10000);
  };

  // =========================================================================
  // Helpers
  // =========================================================================

  async function removeDraftEntry(articleId) {
    try {
      var resp = await ghApi('GET', '/contents/data/drafts.json');
      if (!resp.ok) return;

      var data = await resp.json();
      var content = JSON.parse(b64DecodeUtf8(data.content));

      content.articles = (content.articles || []).filter(function(a) {
        return a.id !== articleId;
      });

      var encoded = b64EncodeUtf8(JSON.stringify(content, null, 2));

      await ghApi('PUT', '/contents/data/drafts.json', {
        message: 'üìã Update drafts.json',
        content: encoded,
        sha: data.sha
      });
    } catch (e) {
      console.warn('Failed to update drafts.json:', e);
    }
  }

  // =========================================================================
  // Deploy queue
  // =========================================================================

  function loadQueue() {
    try {
      var saved = localStorage.getItem('konopla_deploy_queue');
      approvedQueue = saved ? JSON.parse(saved) : [];
    } catch (e) {
      approvedQueue = [];
    }
  }

  function saveQueue() {
    localStorage.setItem('konopla_deploy_queue', JSON.stringify(approvedQueue));
  }

  function renderQueue() {
    var container = document.getElementById('deploy-queue');
    var itemsEl = document.getElementById('queue-items');
    var countEl = document.getElementById('queue-count');

    if (!approvedQueue.length) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'block';
    countEl.textContent = approvedQueue.length;

    itemsEl.innerHTML = approvedQueue.map(function(item, idx) {
      return '<div class="queue-item">' +
        '<span class="queue-item-title">' + escHtml(item.title) + '</span>' +
        '<span class="queue-item-cat">' + escHtml(item.category || '') + '</span>' +
        '<button class="queue-item-remove" onclick="removeFromQueue(' + idx + ')" title="–ü—Ä–∏–±—Ä–∞—Ç–∏">‚úï</button>' +
      '</div>';
    }).join('');
  }

  window.removeFromQueue = function(idx) {
    approvedQueue.splice(idx, 1);
    saveQueue();
    renderQueue();
  };

  window.clearQueue = function() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç–∏ —á–µ—Ä–≥—É? (–°—Ç–∞—Ç—Ç—ñ –≤–∂–µ —Å—Ö–≤–∞–ª–µ–Ω—ñ, –∞–ª–µ –¥–µ–ø–ª–æ–π –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è)')) return;
    approvedQueue = [];
    saveQueue();
    renderQueue();
  };

  window.deployAll = async function() {
    if (!approvedQueue.length) return;
    if (!confirm('–ó–∞–¥–µ–ø–ª–æ—ó—Ç–∏ ' + approvedQueue.length + ' —Å—Ç–∞—Ç–µ–π?')) return;

    showStatus('‚è≥ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—é...', 'info');

    try {
      await triggerDeploy();
      var count = approvedQueue.length;
      approvedQueue = [];
      saveQueue();
      renderQueue();
      showStatus('üöÄ –î–µ–ø–ª–æ–π –∑–∞–ø—É—â–µ–Ω–æ! ' + count + ' —Å—Ç–∞—Ç–µ–π –∑\'—è–≤–ª—è—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç—ñ –∑–∞ 1-2 —Ö–≤.', 'success');
    } catch (e) {
      showStatus('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–µ–ø–ª–æ—é: ' + e.message, 'error');
    }
  };

  async function triggerDeploy() {
    try {
      await ghApi('POST', '/actions/workflows/moderate.yml/dispatches', {
        ref: 'main'
      });
    } catch (e) {
      console.warn('Failed to trigger deploy:', e);
    }
  }

  // UTF-8 safe base64 decode/encode
  function b64DecodeUtf8(b64) {
    var binStr = atob(b64);
    var bytes = new Uint8Array(binStr.length);
    for (var i = 0; i < binStr.length; i++) {
      bytes[i] = binStr.charCodeAt(i);
    }
    return new TextDecoder('utf-8').decode(bytes);
  }

  function b64EncodeUtf8(str) {
    var bytes = new TextEncoder().encode(str);
    var binStr = '';
    for (var i = 0; i < bytes.length; i++) {
      binStr += String.fromCharCode(bytes[i]);
    }
    return btoa(binStr);
  }

  async function ghApi(method, path, body) {
    var url = 'https://api.github.com/repos/' + GITHUB_REPO + path;
    var opts = {
      method: method,
      headers: {
        'Authorization': 'Bearer ' + ghToken,
        'Accept': 'application/vnd.github+json',
        'X-GitHub-Api-Version': '2022-11-28'
      }
    };
    if (body) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }
    return fetch(url, opts);
  }

  function showStatus(msg, type) {
    var el = document.getElementById('status-bar');
    el.textContent = msg;
    el.className = 'admin-status ' + (type || 'info');
    el.style.display = 'block';

    if (type === 'success') {
      setTimeout(function() {
        el.style.display = 'none';
      }, 5000);
    }
  }

  function escHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  function disableCard(card) {
    if (!card) return;
    card.style.opacity = '0.5';
    card.style.pointerEvents = 'none';
  }

  function enableCard(card) {
    if (!card) return;
    card.style.opacity = '1';
    card.style.pointerEvents = '';
  }

  // Expose for onclick
  window.logout = logout;

  // Init
  init();

})();
</script>
{{ end }}
